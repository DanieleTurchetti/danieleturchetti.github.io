<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lab3_smoothing – DEVUL Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e3b7bb8e06e71ba88653cd3334f68afa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">DEVUL Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="./Lecture1a_IntroViz.html">
 <span class="dropdown-text">Lecture 1a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture1b_Variables.html">
 <span class="dropdown-text">Lecture 1b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab1_ExplContVar.html">
 <span class="dropdown-text">Practical 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop1_CategoricalVariables.html">
 <span class="dropdown-text">Workshop 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2a_ManyCatVar.html">
 <span class="dropdown-text">Lecture 2a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2b_ManyContVar.html">
 <span class="dropdown-text">Lecture 2b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab2_ManyCatVariables.html">
 <span class="dropdown-text">Practical 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop2_DepRelAss.html">
 <span class="dropdown-text">Workshop 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3a_SmoothingKDE.html">
 <span class="dropdown-text">Lecture 3a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3b_TimeSeries.html">
 <span class="dropdown-text">Lecture 3b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab3_Smoothing.html">
 <span class="dropdown-text">Practical 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop3_TimeSeries.html">
 <span class="dropdown-text">Workshop 3</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#practical-3---smoothing-and-density-estimation" id="toc-practical-3---smoothing-and-density-estimation" class="nav-link active" data-scroll-target="#practical-3---smoothing-and-density-estimation">Practical 3 - Smoothing and Density Estimation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="practical-3---smoothing-and-density-estimation" class="level1">
<h1>Practical 3 - Smoothing and Density Estimation</h1>
<div style="background-color: #f0f8ff; border: 2px solid #4682b4; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h2 style="color: #4682b4; margin-top: 5px;" class="anchored" data-anchor-id="practical-3---smoothing-and-density-estimation">
Introduction
</h2>
<p>
This practical is designed to enhance your understanding of smoothing and density estimation techniques.
</p>
<p>
By the end of the lab, you will have acquired the following skills:
</p><ul style="font-size: 16px; color: #333;">
<li>
Smoothing a data set to extract a smooth trend using <code>ksmooth</code> and <code>loess</code>
</li>
<li>
Add curves to a plot using the <code>lines</code> function, and shaded regions using <code>polygon</code>
</li>
<li>
Add a smooth trend and confidence interval to a scatterplot
</li>
<li>
Estimate a smooth density function of a single variable using the <code>density</code> function.
</li>
<li>
Add smooth densities to histograms, and draw <em>violin plots</em> and <em>ridgeline plots</em>
</li>
<p></p>
</ul></div>
<p><strong>You will need to install the following packages</strong>:</p>
<ul>
<li><code>ggplot2</code> for the violin plot</li>
<li><code>ggridges</code> for the ridgeline plot</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">"ggplot2"</span>,<span class="st">"ggridges"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="smoothing---recap" class="level2">
<h2 class="anchored" data-anchor-id="smoothing---recap">Smoothing - recap</h2>
<p>Smoothing is a very powerful technique used all across data analysis. Other names given to this technique are <em>curve fitting</em> and <em>low pass filtering</em>. It is designed to detect trends in the presence of noisy data where the shape of the trend is unknown. The smoothing name comes from the fact that to accomplish this feat, we assume that the trend is smooth, as in a smooth surface. In contrast, the noise, or deviation from the trend, is unpredictably wobbly. The justification for this is that conditional expectations or probabilities can be thought of as trends of unknown shapes that we need to estimate in the presence of uncertainty.</p>
<p><i class="fa fa-database"></i> Download data: <a href="UN.Rda">UN</a></p>
<p>The data we’ll use to explore smoothing is the <code>UN</code> data set comprising various measures of national statistics on health, welfare, and education for 213 countries and other areas from 2009-2011, as reported by the UN. Let’s consider the relationship between the wealth of the country (as measured by the GDP per person, in 1000s US dollars) and infant mortality (defined as deaths by age 1 year per 1000 live births).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We quite clearly see a strong relationship here, but it is far from linear. Poorer countries have higher levels of infant mortality, and wealthier countries have lower mortality rates. We also seee that beyond a point, further increases in GDP do not result in further reduction in mortality, and similarly the very poor countries have higher, and much more variable, infant mortality rates. We also notice one possible outlier with a very high infant mortality compared to other countries of similar GDP (this turns out to be Equatorial Guinea).</p>
</section>
<section id="exercise-1-moving-averages" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1-moving-averages">Exercise 1 (Moving averages)</h2>
<p>The general idea of a moving average is to group data points into a local neighbourhood in which the value of the trend is assumed to be constant, which we estimate by the average of these nearby points. Then as we move along the x-axis, our neighbourhood and hence the estimate of the trend will change.</p>
<p>To fit a moving average, we use the <code>ksmooth</code> function using a <code>"box"</code> kernel and a <code>bandwidth</code> to govern the size of the neighbourhood as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The object we’ve created is a list with components <code>x</code> and <code>y</code> corresponding to our estimates of the smooth trend (<code>y</code>) at the corresponding values of GDP (<code>x</code>). We now just need to add this to our plot.</p>
<p>We can use <code>R</code>’s line drawing functions to add curves to a plot via the <code>lines</code> function, which takes a vector of <code>x</code> and <code>y</code> values and draws straight-line segments connecting then <strong>on top of the current plot</strong>.</p>
<p>Let’s add our moving average trend to the scatterplot</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"gray"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While it mostly follows the shape of the data, there are some obvious issues:</p>
<ul>
<li>The trend is still quite noisy, and not quite the smooth curve we might expect</li>
<li>There are gaps in the trend - this is where our data points are so far apart that we have no data points in the neighbourhood to produce an average</li>
<li>The moving average is very sensitive to extremes and outliers. Notice how the trend is ‘pulled upwards’ by a few large mortality values at the left of the plot.</li>
</ul>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 1a
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Repeat the commands above but increase the bandwidth
</li>
<li>
Add your new smooth trend to the plot using a different colour of line.
</li>
<li>
How does the outlier affect the shape of the line?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>Here’s a comparison with a smooth of bandwidth 15:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fitlarge <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">15</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"gray"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitlarge<span class="sc">$</span>x, <span class="at">y=</span>fitlarge<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
We see a much smaller effect of the outlier on the blue smooth compared to the red one.
</details>
<section id="kernels" class="level3">
<h3 class="anchored" data-anchor-id="kernels">Kernels</h3>
<p>Kernel smoothers replace a moving average of nearby points with a weighted average of all the data, with nearer points having more contribution than more distant points.</p>
<p>We can fit the kernel smoother using the same <code>ksmooth</code> function, but now we must change the <code>kernel</code> argument. This smoother only supports the <code>normal</code> (Gaussian) or <code>box</code> (Uniform) kernel functions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">kernel =</span> <span class="st">"normal"</span>, <span class="at">bandwidth =</span> <span class="dv">5</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"gray"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see a number of notable changes here:</p>
<ul>
<li>The trend is much smoother</li>
<li>We still have a gap where our data are sparse - the bandwidth is still too small</li>
<li>There is a bump in the trend near the outlier we identified earlier, and a bump around <code>GDP=75</code> where our data are sparse and influenced by one larger value</li>
</ul>
<p>Overall, this looks to be doing a better job, but still rather susceptible to extreme values.</p>
<p>If we want to implement a different kernel function, we can either use some extra package or do it manually. In theory, the Epanechnikov kernel is the optimal one: here’s code to define this kernel function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>K_epa <span class="ot">&lt;-</span> <span class="cf">function</span>(u){<span class="fl">0.75</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> u<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> (<span class="fu">abs</span>(u) <span class="sc">&lt;=</span> <span class="dv">1</span>)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can plot this function, to make sure that it has the expected shape</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, <span class="at">length =</span> <span class="dv">400</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(u, <span class="fu">K_epa</span>(u), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"u = (x - x_i) / h"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"K(u)"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Epanechnikov Kernel Function"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 1b
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Use <code>K_epa</code> to create a manual Epanechnikov smoothing on the plot of <code>ppgdp</code> versus <code>infantMortality</code>. You can choose a bandwidth yourself, or create a function that allows for different choices of bandwidth
</li>
<li>
Try your smoothing with different bandwidths and compare your results
</li>
<li>
Which of the following has a bigger effect on the smoothing: the choice of kernel or the choice of bandwidth?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>Recall from lecture that the <em>kernel smoother</em> of <span class="math inline">\((x_1,y_1), \dots,(x_n,y_n)\)</span> at <span class="math inline">\(x_0\)</span> is defined as: <span class="math display">\[\hat{f}(x_0)= \sum_{i=1}^n w_i(x_0) y_i\]</span></p>
<p>and that the weigths are defined in terms of the Kernel function as <span class="math display">\[w_i(x;h)=\frac{K\left(\frac{x-x_i}{h}\right)}{\sum\nolimits_{i=1}^nK\left(\frac{x-x_i}{h}\right)}.\]</span> We can use this to create our kernel smoother</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>epa_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, xi, h) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> (x <span class="sc">-</span> xi) <span class="sc">/</span> h</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">K_epa</span>(u) <span class="sc">*</span> y) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">K_epa</span>(u))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>and we can then fit it to our data</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co">#Here you choose your bandwidth</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> UN<span class="sc">$</span>ppgdp</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> UN<span class="sc">$</span>infantMortality</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ord <span class="ot">&lt;-</span> <span class="fu">order</span>(x) <span class="co">#Remember to order your x values, or the line is going to look messy!</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x[ord]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> y[ord]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>x_grid <span class="ot">&lt;-</span> x</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>y_epa <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x_grid, <span class="cf">function</span>(x0) <span class="fu">epa_smooth</span>(x, y, x0, h))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"gray"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x_grid, y_epa, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"purple"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
Playing around with both bandwidth and kernels, we realise that the choice of bandwidth is much more consequential than the choice of kernel (that’s perhaps why the <code>ksmooth</code> function doesn’t support many different kernels!)
</details>
</section>
<section id="local-regression-and-loess" class="level3">
<h3 class="anchored" data-anchor-id="local-regression-and-loess">Local regression and Loess</h3>
<p>Local regression methods work in a similar way to our kernel smoother above, only instead of estimating the trend by a local mean weighting by nearby data we fit a linear regression using a similar weighting. We typically need to use a much larger bandwidth to have enough points to adequately estimate the regression line, but the results are generally closer to a more stable and smooth trend function.</p>
<p>The technique we have looked at is achieved using the <code>loess</code> function, which takes a <code>span</code> argument to represent the proportion of the entire data set used to estimate the trend. This <code>span</code> plays the same role as the <code>bandwidth</code> parameter does.</p>
<p>It’s a little more work to add the loess smoother to our plots, as we must separately <em>fit</em> the model and then <em>predict</em> the trend at some new locations (the <code>ksmooth</code> did both jobs for us). However,</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fit the model, using 2/3 of the data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(infantMortality<span class="sc">~</span>ppgdp, <span class="at">data=</span>UN, <span class="at">span=</span><span class="fl">0.66</span>) </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">## create a sequence of points to cover the x-axis</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(UN<span class="sc">$</span>ppgdp), <span class="fu">max</span>(UN<span class="sc">$</span>ppgdp), <span class="at">length=</span><span class="dv">200</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="do">## get the predicted trend at the new locations, and the error too</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">ppgdp=</span>xs), <span class="at">se =</span> <span class="cn">TRUE</span>) </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">## redraw the plot</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>) </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">## add the loess prediction</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">4</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see the loess curve is much smoother and better behaved, however it is still influenced by the outliers in the data.</p>
<p>Since the loess curve is built upon ideas of regression, we can use regression theory to extact confidence intervals for our loess trend. The <code>predict</code> function here returns a list with many elements. We have used <code>fit</code> to get the predicted trend lines, but we can use the <code>se.fit</code> component to build an approximate confidence interval.</p>
<p>To do this, we’ll create a vector for the upper and lower limits of the confidence interval and use <code>lines</code> to add these limits to our plot:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>upr <span class="ot">&lt;-</span> lpred<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>lpred<span class="sc">$</span>se.fit <span class="do">## upper limit of 95% CI</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>lwr <span class="ot">&lt;-</span> lpred<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>lpred<span class="sc">$</span>se.fit <span class="do">## lower limit of 95% CI</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>upr,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">1</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lwr,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">1</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A couple of things to note here:</p>
<ul>
<li>These confidence intervals are intervals for the location of the <strong>trend</strong>, not for the data. We do <strong>not</strong> expect most of our data to be between these limits.</li>
<li>Notice how our uncertainty grows to the right of the plot where we have fewest data.</li>
</ul>
<p>A nicer way to represent the confidence interval is by using a shaded region.</p>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 1c
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Familiarize yourself with the function <code>polygon</code>, in particular look at the type of input that this function takes, and at how to set options <code>col</code> and <code>border</code>
</li>
<li>
Using the upper and lower limits for the confidence intervals computed above, construct a polygon corresponding to the confidence region
</li>
<li>
Add a shaded colour to the polygon and remove the border, in such a way to get a nice visualisation of the confidence interval as a shaded region
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>The <code>polygon</code> function can be used to draw shaded regions on an existing plot. The default syntax is:</p>
<p><code>polygon(x, y, col=NA, border=NULL)</code></p>
<ul>
<li>The <code>x</code> and <code>y</code> arguments take the <span class="math inline">\((x,y)\)</span> coordinates of the shape to draw.</li>
<li>The default for <code>col</code>our draws no fill, so it is advisable to set a colour here.</li>
<li>The default <code>border</code> outlines the region with a black solid line. To disable the border, set this to <code>NA</code>.</li>
</ul>
<p>We can use our confidence limits to draw the polygon, however we need to combine the points before calling polygon.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>UN<span class="sc">$</span>ppgdp, <span class="at">y=</span>UN<span class="sc">$</span>infantMortality, <span class="at">xlab=</span><span class="st">"GDP"</span>, <span class="at">ylab=</span><span class="st">"Infant Mortality"</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">## we need 'scales' to use the alpha function for transparency</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales) </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="at">x=</span><span class="fu">c</span>(xs,<span class="fu">rev</span>(xs)), </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">y=</span><span class="fu">c</span>(upr,<span class="fu">rev</span>(lwr)), <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'red'</span>,<span class="fl">0.2</span>), <span class="at">border=</span><span class="cn">NA</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
Here we defined <code>y</code> as <code>c(upr,rev(lwr))</code>, i.e.&nbsp;the upper CI followed by the reversed lower CI. This is because polygon joins successive points together, so we must reverse the order of one of the vectors so we can draw around the shape correctly.
</details>
</section>
</section>
<section id="exercise-2-academic-salaries" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2-academic-salaries">Exercise 2 (Academic salaries)</h2>
<p><i class="fa fa-database"></i> Download data: <a href="Salaries.Rda">Salaries</a></p>
<p>The <code>Salaries</code> data set contains the 2008-09 nine-month academic salary for Assistant Professors, Associate Professors and Professors in a University in the USA. The data were collected as part of the on-going effort of the college’s administration to monitor salary differences between male and female faculty members. Let’s take a look at two variables in particular - <code>salary</code>, and <code>yrs.since.phd</code> - the number of years since they completed their PhD, as a measure of “experience”. Let’s take a look at the data.</p>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 2a
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Familiarize yourself with the dataset, then draw a scatterplot of the <code>yrs.since.phd</code> and <code>salary</code>, with <code>salary</code> on the vertical axis.
</li>
<li>
What do you conclude about the relationship? Does it agree with what you expected?
</li>
<li>
Choose two types of smoother among those seen above and add them to your plot as a different coloured lines. Experiment with different bandwidth values and spans. How do your different smoothers compare?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Salary increases with experience, but appears to drop off at high values of experience (seems odd). Recall that this is “years since PhD”, so anyone with 50+ years since PhD is probably age 75+, these are possibly semi-retired senior professors. Let us now fit a moving average smoother</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">10</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>a kernel smoother</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel =</span> <span class="st">"normal"</span>, <span class="at">bandwidth =</span> <span class="dv">10</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>and a LOESS smoother</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(salary<span class="sc">~</span>yrs.since.phd, <span class="at">data=</span>Salaries, <span class="at">span=</span><span class="fl">0.66</span>) </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## create a sequence of points to cover the x-axis</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(Salaries<span class="sc">$</span>yrs.since.phd), <span class="fu">max</span>(Salaries<span class="sc">$</span>yrs.since.phd), <span class="at">length=</span><span class="dv">200</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get the predicted trend at the new locations, and the error too</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">yrs.since.phd=</span>xs), <span class="at">se =</span> <span class="cn">TRUE</span>) </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="do">## add the loess prediction</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit, <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">4</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
As expected, the simple moving average is the most rough, the kernel is a much more smooth function, and the loess is smoother still. All three make the general trend of the data clear: it appears nonlinear
</details>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 2b
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Redraw the scatterplot, and add your loess curve as a solid line.
</li>
<li>
Follow the steps above to add the confidence interval to your plot - either as curves, or as a shaded area, or both!
</li>
<li>
Use <code>lm</code> to fit a simple linear regression of the form <code>salary~yrs.since.phd</code>, and add this to the plot. Is this consistent with your smoothed trend and its confidence interval?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>Let us redraw both the plot and the LOESS smoother, adding confidence interval as a shaded region</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit, <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">4</span>) </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">## confidence limits</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>upr <span class="ot">&lt;-</span> lpred<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>lpred<span class="sc">$</span>se.fit</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>lwr <span class="ot">&lt;-</span> lpred<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>lpred<span class="sc">$</span>se.fit</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="do">## draw the shape</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="at">x=</span><span class="fu">c</span>(xs,<span class="fu">rev</span>(xs)), </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">y=</span><span class="fu">c</span>(upr,<span class="fu">rev</span>(lwr)),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'green'</span>,<span class="fl">0.2</span>), <span class="at">border=</span><span class="cn">NA</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The relationship is not linear, but let us look at the straight line fit anyway</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lmfit <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary<span class="sc">~</span>yrs.since.phd, <span class="at">data=</span>Salaries)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>lpred<span class="sc">$</span>fit, <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">4</span>) </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(lmfit,<span class="at">col=</span><span class="st">'orange'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
This really doesn’t look right - if it were consistent we’d expect it to be close to the smoothed trend and its confidence interval.
</details>
<p>There are a couple of categorical variables in this data set - the <code>sex</code> of the academic, and their <code>rank</code> - one of <code>Prof</code>, <code>AssocProf</code> or <code>AsstProf</code> representing Professor, Associate Professor, and Assistant Professor (in descending order of seniority).</p>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 2c
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Use colour to highlight the different sexes. What features can you see?
</li>
<li>
Use colour to highlight the different ranks - what do you see?
</li>
<li>
What do you think about your trend now?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">col=</span>Salaries<span class="sc">$</span>sex)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="do">## red=male, black=female</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">'topright'</span>, <span class="at">legend=</span><span class="fu">levels</span>(Salaries<span class="sc">$</span>sex), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The legend function can add the colour and labels and save us having to decipher that female academics are younger (fewer years of experience), and seemingly less well paid.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">col=</span>Salaries<span class="sc">$</span>rank)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">'topright'</span>, <span class="at">legend=</span><span class="fu">levels</span>(Salaries<span class="sc">$</span>rank), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(Salaries<span class="sc">$</span>rank))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot changes everything! It looks strongly like salary just changes with the job rank. For the lower ranks, the relationship appears flat. Though there is some curvature in the <code>Professor</code> group.</p>
<p>As a little extra, we can use a for loop to fit and draw a LOESS curve for each subgroup</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>Salaries<span class="sc">$</span>yrs.since.phd, <span class="at">y=</span>Salaries<span class="sc">$</span>salary,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">col=</span>Salaries<span class="sc">$</span>rank)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">'topright'</span>, <span class="at">legend=</span><span class="fu">levels</span>(Salaries<span class="sc">$</span>rank), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(Salaries<span class="sc">$</span>rank))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="do">## loop over each salary level</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(Salaries<span class="sc">$</span>rank)){</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">levels</span>(Salaries<span class="sc">$</span>rank)[i] <span class="do">## extract the factor label</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## fit a loess on the subset of the data</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">loess</span>(salary<span class="sc">~</span>yrs.since.phd, <span class="at">data=</span>Salaries[Salaries<span class="sc">$</span>rank<span class="sc">==</span>r,], <span class="at">span=</span><span class="fl">0.66</span>) </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## and extract and plot</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  prd <span class="ot">&lt;-</span> <span class="fu">predict</span>(tmp, <span class="fu">data.frame</span>(<span class="at">yrs.since.phd=</span>xs), <span class="at">se =</span> <span class="cn">TRUE</span>) </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">x=</span>xs, <span class="at">y=</span>prd<span class="sc">$</span>fit, <span class="at">col=</span>i,<span class="at">lwd=</span><span class="dv">4</span>) </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
We find that red and black are indeed mostly flat, though green shows curvature (due to those old profs seen earlier on).
</details>
</section>
<section id="density-estimation" class="level2">
<h2 class="anchored" data-anchor-id="density-estimation">Density Estimation</h2>
<p>Kernel density estimation (KDE) is a nonparametric method which uses kernels (as we’ve seen above) to estimate the probability density function of a continuous random variable. In simpler words, we are trying to produce a smoothed version of a histogram.</p>
<p>A density estimate is relatively easy to construct using the <code>density</code> function in R. It takes a few useful arguments:</p>
<ul>
<li><code>x</code> - the data</li>
<li><code>bw</code> - the bandwidth parameter. If not specified, R will try and determine a value for itself.</li>
<li><code>kernel</code> - the kernel function to use. Options include <code>gaussian</code>, <code>rectangular</code>, <code>triangular</code>, <code>epanechnikov</code>. Default is <code>gaussian</code>.</li>
</ul>
<p>It then spits out an object with <code>x</code> and <code>y</code> components that we can <code>plot</code> or add to a plot with <code>lines</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## draw a histogram of GDP on density scale</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(UN<span class="sc">$</span>ppgdp, <span class="at">freq=</span><span class="cn">FALSE</span>,<span class="at">main=</span><span class="st">''</span>,<span class="at">xlab=</span><span class="st">'GDP'</span>) </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> <span class="do">## add a rugplot to see where the points lie</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(UN<span class="sc">$</span>ppgdp)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">## a density estimate with Gaussian kernel and bandwidth of 5</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">density</span>(UN<span class="sc">$</span>ppgdp, <span class="at">bw=</span><span class="dv">5</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d1<span class="sc">$</span>x, <span class="at">y=</span>d1<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="do">## bandwidth of 10</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">density</span>(UN<span class="sc">$</span>ppgdp, <span class="at">bw=</span><span class="dv">10</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d2<span class="sc">$</span>x, <span class="at">y=</span>d2<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="do">## bandwidth of 2</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">density</span>(UN<span class="sc">$</span>ppgdp, <span class="at">bw=</span><span class="dv">2</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d3<span class="sc">$</span>x, <span class="at">y=</span>d3<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="do">## let R choose a bandwidth</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">density</span>(UN<span class="sc">$</span>ppgdp)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d4<span class="sc">$</span>x, <span class="at">y=</span>d4<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'orange'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>R</code> does a reasonable job at guessing a not-too-stupid bandwidth parameter. To estimate the bandwidth, <code>R</code> calls the <code>bw.nrd0</code> function on the data - read the help file if you want to know more.</p>
<p>Alternatively, we could skip the histogram altogether and just draw the density estimate:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## draw the line</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>d4<span class="sc">$</span>x, <span class="at">y=</span>d4<span class="sc">$</span>y,<span class="at">xlab=</span><span class="st">'GDP'</span>,<span class="at">ylab=</span><span class="st">'Density'</span>,<span class="at">ty=</span><span class="st">'l'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="do">## and add some fill to make it prettier</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="at">x=</span>d4<span class="sc">$</span>x, <span class="at">y=</span>d4<span class="sc">$</span>y, <span class="at">border=</span><span class="cn">NA</span>, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'red'</span>,<span class="fl">0.4</span>)) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This can be a helpful tool for comparing the densities from different groups in a single plot.</p>
<section id="violin-plots" class="level3">
<h3 class="anchored" data-anchor-id="violin-plots">Violin plots</h3>
<p>The <em>violin plot</em> is a combination of ideas of a boxplot and the kernel density estimate above. Rather than drawing the crude box-and-whiskers of a boxplot, we instead draw a back-to-back density estimate.</p>
<p><i class="fa fa-database"></i> Download data: <a href="chickwts.Rda">chickwts</a></p>
<p>To illustrate, this consider the <code>chickwts</code> data set, which records the weight of 71 chicks fed on a six different feed supplements. Newly-hatched chicks were randomly allocated into six groups, and each group was given a different feed supplement. They were then weighed after six weeks. A separate boxplot can be drawn for each level of a categorical variable using the following code (not again the use of the linear model <code>formula</code> notation)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(weight<span class="sc">~</span>feed,<span class="at">data=</span>chickwts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A violin plot takes the same layout of the boxplot, but draws a (heavily) smoothed density estimate instead of the box and whiskers.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(feed), <span class="at">y =</span> weight)) <span class="sc">+</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>, <span class="at">color =</span> <span class="st">"#473e2c"</span>, <span class="at">adjust=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Feed Supplement"</span>, <span class="at">y =</span> <span class="st">"Chick Weight (g)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Violin plots can be quite effective at conveying the information of both a histogram and a boxplot in one graphic. As with most density estimates, experimenting with the bandwidth is usually a good idea - in this case the <code>adjust</code> parameter.</p>
<p>Finally, the plotting code for making a violin plot is a lot more involved than usual! <code>ggplot</code> is a powerful, but alternative, method of plotting in R. We’ve generally avoided it as it uses a fundamentally different plotting system to our regular graphics and takes rather more work to understand. However, it is exceptionally flexible and with it you can do many things that would be difficult otherwise, for instance:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(feed), <span class="at">y =</span> weight)) <span class="sc">+</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>, <span class="at">color =</span> <span class="st">"#473e2c"</span>, <span class="at">adjust=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Feed Supplement"</span>, <span class="at">y =</span> <span class="st">"Chick Weight (g)"</span>) <span class="sc">+</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_boxplot</span>(<span class="at">width=</span><span class="fl">0.1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ridgeline-plots" class="level3">
<h3 class="anchored" data-anchor-id="ridgeline-plots">Ridgeline plots</h3>
<p>Ridgeline plots, also called <em>ridge plots</em>, are another way to show density estimates for a number of groups. Much like the violin plot, we draw a separate density estimate for each group, but in the ridge line plot, the densities are stacked vertically to look like a line of hills or ridges (hence the name).</p>
<p>Again, this uses the <code>gg</code> family of plotting functions, but can easily be adapted. The main control parameter here is the <code>scale</code> which affects the height of the individual densities:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, <span class="fu">aes</span>(weight, <span class="at">y=</span><span class="fu">factor</span>(feed), <span class="at">fill=</span>feed)) <span class="sc">+</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">scale =</span> <span class="fl">1.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-diamond-prices" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-diamond-prices">Exercise 3 (Diamond Prices)</h3>
<p><i class="fa fa-database"></i> Download data: <a href="diamonds.Rda">diamonds</a></p>
<p>The <code>diamonds</code> data set contains information on the prices and other attributes of 53,940 diamonds. In particular, it gives the weight (<code>carat</code>) and <code>price</code> of each diamond, as well as categorical variables representing the quality of the <code>cut</code> (Fair, Good, Very Good, Premium, Ideal), the diamond <code>color</code> (from D=best, to J=worst), and <code>clarity</code> representing how clear the diamond is (I1 (worst), SI2, SI1, VS2, VS1, VVS2, VVS1, IF (best)).</p>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 3a
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Explore the distribution of the <code>carat</code> of the diamonds. Start with a histogram and experiment with different numbers of bars.
</li>
<li>
Now make some density estimates and experiment with different bandwidths to produce a smoothed version of your histogram. Add these to your plot.
</li>
<li>
Do the same as above for the distribution of prices.
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>It is OK to try a few histograms before finding one that works</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(diamonds<span class="sc">$</span>carat,<span class="at">breaks=</span><span class="dv">100</span>,<span class="at">freq=</span><span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this one, we see several distinct peaks (perhaps groups?), and very strong skewness. We can try density estimation with different bandwidths</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(diamonds<span class="sc">$</span>carat,<span class="at">breaks=</span><span class="dv">100</span>,<span class="at">freq=</span><span class="cn">FALSE</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">density</span>(diamonds<span class="sc">$</span>carat, <span class="at">bw=</span><span class="dv">1</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d1<span class="sc">$</span>x, <span class="at">y=</span>d1<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">density</span>(diamonds<span class="sc">$</span>carat, <span class="at">bw=</span><span class="fl">0.5</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d2<span class="sc">$</span>x, <span class="at">y=</span>d2<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">density</span>(diamonds<span class="sc">$</span>carat, <span class="at">bw=</span><span class="fl">0.1</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d3<span class="sc">$</span>x, <span class="at">y=</span>d3<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also let <code>R</code> decide the optimal bandwidth</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(diamonds<span class="sc">$</span>carat,<span class="at">breaks=</span><span class="dv">100</span>,<span class="at">freq=</span><span class="cn">FALSE</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bw.nrd0</span>(diamonds<span class="sc">$</span>carat)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04826685</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">density</span>(diamonds<span class="sc">$</span>carat)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d4<span class="sc">$</span>x, <span class="at">y=</span>d4<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'orange'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As for the variable <code>price</code>, the code is the same as above</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(diamonds<span class="sc">$</span>price,<span class="at">breaks=</span><span class="dv">100</span>,<span class="at">freq=</span><span class="cn">FALSE</span>) </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">density</span>(diamonds<span class="sc">$</span>price)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d4<span class="sc">$</span>x, <span class="at">y=</span>d4<span class="sc">$</span>y, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>we see here fewer peaks, but still an unusual structure and strong skewness.</p>
</details>
We can now try to use the density estimation techniques to compare differences across subgroups.
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 3b
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
How many diamonds are there of the different <code>cut</code>s?
</li>
<li>
How does the distribution of prices change according to the <code>cut</code> of the diamond?
</li>
<ul style="font-size: 13px; color: #333;">
<li>
Try drawing boxplots for each level of <code>cut</code>.
</li>
<li>
How do these compare to violin plots? And ridgeline plots?
</li>
<li>
Do you find any evidence of different behaviour among the groups?
</li>
</ul>
<li>
Perform a similar investigation of the diamond’s <code>carat</code>.
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>cut,<span class="at">data=</span>diamonds))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A histogram shows wide variation in numbers for the different groups of cuts.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(price<span class="sc">~</span>cut, <span class="at">data=</span>diamonds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The distribution is very skewed in all cases. There is a slight variation in medians, and more obvious variation in the upper inter-quartile range. There are lots of candidates for outliers! Butthis is just a side-effect of a big and skewed data set. Without further information, they seem very unlikely to be due to error. Let’s look at the violin plots</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(cut), <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here skewness is apparent again. We can also notice how the shape changes as we go from <code>Fair</code> to <code>Ideal</code>. All groups prices peak around low values. And here are the ridge plots</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(price, <span class="at">y=</span><span class="fu">factor</span>(cut), <span class="at">fill=</span>cut)) <span class="sc">+</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">scale =</span> <span class="fl">1.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 458</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
Here we can clearly see how the shape changes with the cut.
</details>
<div style="background-color: #fff1d6; border: 2px solid #ff4500; padding: 15px; margin: 10px 0; border-radius: 10px;">
<h3 style="color: #ff4500; margin-top: 5px;" class="anchored">
Task 3c
</h3>
<ul style="font-size: 16px; color: #333;">
<li>
Draw plots to show how <code>price</code> changes according to the <code>color</code> of the diamond.
</li>
<li>
Perform a similar investigation of the diamond’s <code>carat</code> with <code>clarity</code>.
</li>
<li>
What conclusions do you draw?
</li>
</ul>
</div>
<details>
<summary>
Click for solution
</summary>
<p>Here again, the best is to start with boxplots</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(price<span class="sc">~</span>color, <span class="at">data=</span>diamonds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see a similar shape as before, but the median is clearly increasing as we go from D to J.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(color), <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the violin plots, we see that the distribution is becoming flatter as D-&gt;J.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(price, <span class="at">y=</span><span class="fu">factor</span>(color), <span class="at">fill=</span>color)) <span class="sc">+</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">scale =</span> <span class="fl">1.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 535</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And as before the ridge plots are easier to interpret: the distribution is more spread out with more ‘humps’ for colours H-J. This is what drags up the median.</p>
<p>In the case of carat vs clarity, we repeat the procedure</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(carat<span class="sc">~</span>clarity, <span class="at">data=</span>diamonds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>getting the “reverse” picture: going from left to right, the carat clearly drops.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(clarity), <span class="at">y =</span> carat)) <span class="sc">+</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Violin plots show a shape that is definitely changing. The distribution is more spread on the left, and more concentrated on the right.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(carat, <span class="at">y=</span><span class="fu">factor</span>(clarity), <span class="at">fill=</span>clarity)) <span class="sc">+</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">scale =</span> <span class="fl">1.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.057</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
Once again, the pattern is easier to see from the ridgeplots: the distribution is moving and becoming more concentrated. We might suspect a bit of undersmoothing as the shapes are very wiggly.
</details>
</section>
<section id="d-density-estimation-optional" class="level3">
<h3 class="anchored" data-anchor-id="d-density-estimation-optional">2D Density estimation (optional)</h3>
<p>The ideas of density estimation can be extended beyond one dimension. If we consider two variables at once, we can estimate their 2-d joint distribution as a smoothed version of a scatterplot. This also provides another alternative method of dealing with overplotting of dense data sets.</p>
<p>Let’s return to the Old Faithful data:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS) <span class="do">## this is a standard package, you shouldn't need to install it</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(geyser)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>geyser<span class="sc">$</span>duration, <span class="at">y=</span>geyser<span class="sc">$</span>waiting,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">'duration'</span>, <span class="at">ylab=</span><span class="st">'waiting'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A 2-D density estimate would smooth the distribution into a surface, picking out two or three peaks corresponding to the clumps in the data. We can fit the 2-D density using the <code>kde2d</code> function from the <code>MASS</code> package. It has few arguments, just the <code>x</code> and <code>y</code> to be smoothed, and an optional <code>n</code> which controls the amount of detail in the resulting smoothed density.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>k1 <span class="ot">&lt;-</span> <span class="fu">kde2d</span>(geyser<span class="sc">$</span>duration, geyser<span class="sc">$</span>waiting, <span class="at">n =</span> <span class="dv">100</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The output of <code>kde2d</code> is a bit more complicated than we get from a 1-D density estimation. It’s now a list with <code>x</code>, <code>y</code>, and <code>z</code> components. The <code>x</code> and <code>y</code> components are the values of the specified variables (here, <code>duration</code> and <code>waiting</code> respectively) which are used to create a grid of points. The density value at every combination of <code>x</code> and <code>y</code> is then estimared and returned in the <code>z</code> component.</p>
<p>The value of <code>n</code> here indicates the number of grid points along each axis, effectively acting as an “inverse bandwidth”. Increasing this will give you smoother output due to making more estimates in a bigger <code>z</code> matrix, but will take longer to evaluate.</p>
<p>We can then add the smoothed density to our scatterplot as <em>contours</em>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>geyser<span class="sc">$</span>duration, <span class="at">y=</span>geyser<span class="sc">$</span>waiting,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">'duration'</span>, <span class="at">ylab=</span><span class="st">'waiting'</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'black'</span>,<span class="fl">0.6</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(k1, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">'blue'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Using <code>add=TRUE</code> we can draw the contours on top of an existing plot. See the help on contour (<code>?contour</code>) for more ways to customise.</p>
<p>Alternatively, we could skip the scatterplot and just draw the contours (useful if we have too many points)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(k1, <span class="at">col=</span><span class="st">'blue'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A different presentation of the density estimate is to draw the surface as a <em>heatmap</em>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(k1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Each rectangular region in the plot is now coloured according to the density estimate. The heatmap is a little blocky due to the resolution of our density estimate. Specifying <code>n=100</code> divides each axis into 100 intervals, giving us 10,000 2-D bins over the range of the data. Like a histogram, we can increase <code>n</code> to see more detail - though it can take a little while to compute.</p>
<p>If we want to overlay the data points, we can use the <code>points</code> function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">kde2d</span>(geyser<span class="sc">$</span>duration, geyser<span class="sc">$</span>waiting, <span class="at">n =</span> <span class="dv">500</span>),</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">'duration'</span>, <span class="at">ylab=</span><span class="st">'waiting'</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x=</span>geyser<span class="sc">$</span>duration, <span class="at">y=</span>geyser<span class="sc">$</span>waiting,<span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'black'</span>,<span class="fl">0.6</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab3_Smoothing_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hertzprung-russell-optional" class="level3">
<h3 class="anchored" data-anchor-id="hertzprung-russell-optional">Hertzprung-Russell (optional)</h3>
<p><i class="fa fa-database"></i> Download data: <a href="HRstars.Rda">HRstars</a></p>
<p>The <a href="https://en.wikipedia.org/wiki/Hertzsprung%E2%80%93Russell_diagram">Hertzsprung-Russell</a> diagram is famous visualisation of the relationship between the absolute magnitude of stars (i.e.&nbsp;their brightness) and their effective temperatures (indicated by their colour). The Hertzsprung-Russell provides an easy way to distinguish different categories of stars according to their position on the plot.</p>
<p>We’re going to look at the <code>HRStars</code> data which contain 6220 stars from the Yale Trigonometric Parallax Dataset.</p>
<ul>
<li>Let’s start with single variables. Have a look at histograms of <code>V</code> and <code>BV</code>.</li>
<li>Do you see any evidence of groups in the data? You’ll need to adjust the number of bars.</li>
</ul>
<p>Univariate summaries can conceal a lot of information when the data are inherently multivariate. So, let’s consider both variables.</p>
<ul>
<li>Draw a plot of the magnitude <code>V</code> vertically against the observed colour <code>BV</code>.</li>
<li>The data contain a lot of points, so reduce your point size by scaling down the symbol size. This can be done by setting the optional argument <code>cex</code> to a value between <code>0</code> and <code>1</code> - the default size is <code>1</code>.</li>
<li>What features do you see? Can you identify any groups in the data? Are there any outliers?</li>
<li>The Sun has an absolute magnitude of 4.8 and B-V colour of 0.66. Use the <code>points</code> function (it works exactly the same way as <code>lines</code>) to add it to your plot - use a different colour and/or plot character to make it stand out.</li>
<li>How does your plot differ from the plots you find on the web? How would you adjust your scatterplot to match?</li>
</ul>
<p>The central ‘wiggle’ in the plot corresponds to <em>main sequence</em> stars. Below that wiggle are the <em>white dwarf</em> stars, and above are the <em>giants</em> and <em>supergiants</em>.</p>
<ul>
<li><p>Fit a 2-D density estimate to the stars data.</p></li>
<li><p>Overlay the contours on your scatterplot (use a different colour and/or transparency).</p></li>
<li><p>The <code>kde2d</code> function takes an argument <code>h</code> which represents the bandwidth. We can supply a single value, or a vector of two values (one for each variable).</p></li>
<li><p>The contour plot seems to miss out the less dense region of dwarf stars in the bottom left due to the low density of points. The default number of contours drawn is 10, and it is set by the <code>nlevels</code> argument. Increase the number of contours until a contour around the dwarf group is visible.</p></li>
<li><p>Alternatively, you can pick the levels at which the contour lines are drawn by specifying a vector as input to the <code>levels</code> argument. I found that <span class="math inline">\(0.005, 0.01, 0.025, 0.05, 0.1, 0.15\)</span> work well - try this now.</p></li>
<li><p>Can you identify the main groups of stars?</p></li>
</ul>
<p>This is more tricky and requires more R programming:</p>
<ul>
<li>Create a new categorical variable to that represents the values of the <code>Uncert</code> variable, which represents the parallax error in the observations. Use three levels:
<ul>
<li><code>Uncert</code> under 50</li>
<li><code>Uncert</code> above 50 but below 100</li>
<li><code>Uncert</code> above 100</li>
</ul></li>
<li>Use your new variable to colour the points in your scatterplot according to this error.</li>
<li>Is this parallax error associated with the properties (and hence types) of observed stars?</li>
</ul>
</section>
<section id="pearsons-heights-optional" class="level3">
<h3 class="anchored" data-anchor-id="pearsons-heights-optional">Pearson’s heights (optional)</h3>
<p><i class="fa fa-database"></i> Download data: <a href="fatherSon.Rda">fatherSon</a></p>
<p>This is another dataset of father and son heights, this time from Karl Pearson (another prominent early statistician). This time we have 1078 paired heights recorded in inches and were published in <a href="https://www.jstor.org/stable/2331507?seq=1">1903</a>. Families were invited to provide their measurements to the nearest quarter of an inch with the note that “the Professor trusts to the <em>bona fides</em> of each recorder to send only correct results.”</p>
<ul>
<li>Draw histograms of the sons’ and fathers’ heights (<code>sheight</code> and <code>fheight</code>). Use a density scale and a bar width of 1 inch.</li>
<li>Compute a density estimate for both distributions.</li>
<li>Draw the histograms side-by-side and overlay your density curves.</li>
<li>Do the data look normally distributed?</li>
</ul>
<p>We should be careful about jumping to conclusions here, or as Pearson put it in his 1903 paper: “It is almost in vain that one enters a protest against the mere graphical representation of goodness of fit, now that we have an exact measure of it.” For the time, he was justified in his demanding both graphical and analytical approaches. Since those early days, analytic approaches have often been too dominant, both are needed.</p>
<ul>
<li>Draw Normal quantile plots of the two variables side-by-side. Do the data look normal?</li>
</ul>
<p>Let’s look at the pairwise relationship between the two heights.</p>
<ul>
<li>Draw a scatterplot of sons’ heights (vertically) against fathers’ heights (horizontally).</li>
<li>Is there a strong association here? Calculate the correlation.</li>
<li>Fit a linear regression (recall in ISDS, you used the <code>lm</code> function). Add the line to your plot.</li>
</ul>
<p>The height of a son is influenced by the height of the father, but there is a lot of unexplained variability. This scatterplot also illustrates a phenomenon known as <em>regression towards the mean</em>. Small fathers havs sons who are small, but on average not as small as their fathers. Tall fathers have sons who are tall, but on average not as tall as their fathers.</p>
<p>To explore further whether a non-linear model would be warranted, we could plot a smoother andt the best fit regression line together.</p>
<ul>
<li>Fit a smoother to the data.</li>
<li>Add it to your plot with a 95% confidence interval.</li>
<li>Are the regression and smoother in agreement?</li>
</ul>


</section>
</section>
</section></main></div>


 <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
 <!-- /content -->




</body></html>