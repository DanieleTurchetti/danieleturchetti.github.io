<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lecture2a_manycatvar – course-notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">course-notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lecture-2a---exploring-many-categorical-variables" id="toc-lecture-2a---exploring-many-categorical-variables" class="nav-link active" data-scroll-target="#lecture-2a---exploring-many-categorical-variables">Lecture 2a - Exploring Many Categorical Variables</a>
  <ul class="collapse">
  <li><a href="#contingency-tables" id="toc-contingency-tables" class="nav-link" data-scroll-target="#contingency-tables">Contingency tables</a></li>
  <li><a href="#visualising-many-categorical-variables" id="toc-visualising-many-categorical-variables" class="nav-link" data-scroll-target="#visualising-many-categorical-variables">Visualising many categorical variables</a></li>
  <li><a href="#example-sinking-of-the-titanic" id="toc-example-sinking-of-the-titanic" class="nav-link" data-scroll-target="#example-sinking-of-the-titanic">Example: Sinking of the Titanic</a>
  <ul class="collapse">
  <li><a href="#composite-barplots" id="toc-composite-barplots" class="nav-link" data-scroll-target="#composite-barplots">Composite Barplots</a></li>
  <li><a href="#mosaic-plots" id="toc-mosaic-plots" class="nav-link" data-scroll-target="#mosaic-plots">Mosaic plots</a></li>
  </ul></li>
  <li><a href="#example-arthritis-treatment" id="toc-example-arthritis-treatment" class="nav-link" data-scroll-target="#example-arthritis-treatment">Example: Arthritis Treatment</a>
  <ul class="collapse">
  <li><a href="#more-than-two-variables" id="toc-more-than-two-variables" class="nav-link" data-scroll-target="#more-than-two-variables">More than two variables</a></li>
  <li><a href="#doubledecker-plot" id="toc-doubledecker-plot" class="nav-link" data-scroll-target="#doubledecker-plot">Doubledecker plot</a></li>
  <li><a href="#example-sinking-of-the-titanic-1" id="toc-example-sinking-of-the-titanic-1" class="nav-link" data-scroll-target="#example-sinking-of-the-titanic-1">Example: Sinking of the Titanic</a></li>
  </ul></li>
  <li><a href="#connection-with-chi2-tests" id="toc-connection-with-chi2-tests" class="nav-link" data-scroll-target="#connection-with-chi2-tests">Connection with <span class="math inline">\(\chi^2\)</span> tests</a>
  <ul class="collapse">
  <li><a href="#first-step-creating-contingency-tables" id="toc-first-step-creating-contingency-tables" class="nav-link" data-scroll-target="#first-step-creating-contingency-tables">First step: Creating Contingency Tables</a></li>
  <li><a href="#second-step-computing-expected-counts" id="toc-second-step-computing-expected-counts" class="nav-link" data-scroll-target="#second-step-computing-expected-counts">Second step: Computing expected counts</a></li>
  <li><a href="#third-step-pearson-residuals-and-x2-statistic" id="toc-third-step-pearson-residuals-and-x2-statistic" class="nav-link" data-scroll-target="#third-step-pearson-residuals-and-x2-statistic">Third step: Pearson residuals and <span class="math inline">\(X^2\)</span>-statistic</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
  <li><a href="#modelling-testing" id="toc-modelling-testing" class="nav-link" data-scroll-target="#modelling-testing">Modelling &amp; Testing</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="lecture-2a---exploring-many-categorical-variables" class="level1">
<h1>Lecture 2a - Exploring Many Categorical Variables</h1>
<p>Categorical data poses a number of problems when we have multiple variables. Suppose we have <span class="math inline">\(J\)</span> categorical variables <span class="math inline">\(X_1,\dots,X_J\)</span>, and each categorical variable has <span class="math inline">\(c_j\)</span> possible categories.</p>
<p>For example, <span class="math inline">\(X_1\)</span> could be Gender with levels Male/Female and <span class="math inline">\(c_1=2\)</span>; then <span class="math inline">\(X_2\)</span> could be Eye Colour with levels Blue/Green/Brown and <span class="math inline">\(c_2=3\)</span>; <span class="math inline">\(X_3\)</span> could be Hair colour with levels Brown/Blond/Black/Red/Grey/White and <span class="math inline">\(c_3=6\)</span>, etc.</p>
<p>Each observed data point is then one combination of the possible categories from each variable - Male + Green Eyes + Red hair, or Female + Brown Eyes + Black hair. In total, there are <span class="math inline">\(C^*=c_1\times c_2\times \dots\times c_J= \prod_j c_j\)</span> possible combinations of categories! In our example, this would be <span class="math inline">\(2\times3\times6=36\)</span>. As the number of variables <span class="math inline">\(J\)</span> and number of categories for the variables <span class="math inline">\(c_j\)</span> get bigger, then <span class="math inline">\(C^*\)</span> can grow very large very quickly and can rapidly become challenging to deal with. It can quickly become possible for there to be more possible combinations of categories than you have data observations - a problem known as <strong>sparsity</strong>.</p>
<section id="contingency-tables" class="level2">
<h2 class="anchored" data-anchor-id="contingency-tables">Contingency tables</h2>
<p>Multivariate categorical data can be summarised by the <strong>counts</strong> of the number of observations in each possible combination of levels of the categorical variables. This collection of counts forms a <strong>contingency table</strong>. In general, the contingency table can be represented as</p>
<ul>
<li>a <span class="math inline">\(J\)</span>-dimensional <strong>array</strong>,</li>
<li>containing a total of <span class="math inline">\(C^*\)</span> <strong>cells</strong></li>
<li>each containing the observed count of <strong>each possible combination</strong> of categories.</li>
</ul>
<p>Sparsity manifests as many of the table entries being zero.</p>
<p>For example, the <code>Alligator</code> data set in the <code>vcdExtra</code> package contains data on 219 observations from a study of the primary food choices of alligators in four Florida lakes. The data set has <span class="math inline">\(J=4\)</span> variables, all categorical:</p>
<ul>
<li>Sex - male, or female</li>
<li>Size - large&nbsp;(&gt;2.3m)&nbsp;small&nbsp;(&lt;=2.3m)</li>
<li>Lake - one of four possible lakes</li>
<li>Food - primary food choice: bird, fish, invertebrate, reptile, other</li>
</ul>
<p>This seems like a relatively modest data set - how many different combinations of categorical variables are there? The answer is <span class="math inline">\(2\times2\times4\times 5=80\)</span>.</p>
</section>
<section id="visualising-many-categorical-variables" class="level2">
<h2 class="anchored" data-anchor-id="visualising-many-categorical-variables">Visualising many categorical variables</h2>
<p>To explore <em>multivariate</em> categorical data, we start with some <em>low-dimensional plots</em>, for 2 or 3 variables. The most effective visualisations are:</p>
<ol type="1">
<li><em>Mosaicplots</em> use <em>area</em> to indicate the <em>counts</em> within categories and combinations of categories.</li>
<li><em>Grids of barplots</em> can also be effective to visualise how a <em>distribution</em> can change across categories.</li>
<li><em>Grouped barplots</em> or <em>stacked barplots</em></li>
</ol>
<p>These plots have the advantage of highlighting some important association features. One shall look at the following questions:</p>
<pre><code>Which categories appear most/least often?
Do the counts and their distributions differ across subgroups?
Is there evidence of dependence or independence between categories?</code></pre>
</section>
<section id="example-sinking-of-the-titanic" class="level2">
<h2 class="anchored" data-anchor-id="example-sinking-of-the-titanic">Example: Sinking of the Titanic</h2>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>titanic <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Titanic)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Data on the 2201 people on board the Titanic at the time of its sinking:</p>
<ul>
<li><em>Class</em> - 1st, 2nd, 3rd, or crew</li>
<li><em>Sex</em> - male, or female</li>
<li><em>Age</em> - child, or adult</li>
<li><em>Survived</em> - survived or died</li>
</ul>
<p>There are 32 combinations of factors here. Interest in these data centres on whether factors like Class or Sex affected survival. We’ll come to this soon, but first let’s just focus on the individual variables.</p>
<p>The raw data for categorical variables are not terribly easy to interpret:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(titanic[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Class    Sex   Age Survived Freq
1    1st   Male Child       No    0
2    2nd   Male Child       No    0
3    3rd   Male Child       No   35
4   Crew   Male Child       No    0
5    1st Female Child       No    0
6    2nd Female Child       No    0
7    3rd Female Child       No   17
8   Crew Female Child       No    0
9    1st   Male Adult       No  118
10   2nd   Male Adult       No  154</code></pre>
</div>
</div>
<p>Simple barplots of the individual factors show some general features of the <em>marginal</em> distributions and are a good place to start:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Here we see that:</p>
<ul>
<li>Twice as many people died than survived</li>
<li>Most people were crew rather than passengers</li>
<li>Considerably more people onboard were male than female (crew were mostly male)</li>
<li>Far more adults onboard than children</li>
</ul>
<section id="composite-barplots" class="level3">
<h3 class="anchored" data-anchor-id="composite-barplots">Composite Barplots</h3>
<p>It can be helpful to focus on a single <strong>response</strong> variable of primary interest to investigate in relation to the others. In the case of the Titanic data, the <code>Survived</code> variable is most of interest. We want to explore how the distribution of the number of survivors is <strong>affected</strong> by the other variables.</p>
<p>A simple variation of the barplot is to break apart each bar into the pieces according to combinations with other variables. This gives a <strong>stacked barplot</strong>. For example, we can decompose the number of survivors by Class:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Class, titanic),  <span class="at">beside=</span><span class="cn">FALSE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'green3'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can see the variations in the nunmber of survivors within each of the bars. This can be helpful to compare the proportions of the sub-groups of Survivors within each bar. For instance, we see that a greater share of passengers in 1st class survived, compared to the rest. However, as the heights of each bar differ it can be difficult to directly compare the numbers in the subgroups for the different bars.</p>
<p>Alternatively, we can group the bars side-by-side rather than stacking them. This can help if we want to compare the total amounts across classes, rather than proportions.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Class, titanic), <span class="at">beside=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s now far clearer that more 1st class passengers survived than did not, and this situation was dramatically reversed for the other passengers. Only a small proportion of the Crew and those in 3rd class surivived.</p>
<p>We can repeat this process to look at the effects of the other variables:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Sex, titanic),  <span class="at">beside=</span><span class="cn">FALSE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Sex, titanic), <span class="at">beside=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Age, titanic),  <span class="at">beside=</span><span class="cn">FALSE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Age, titanic), <span class="at">beside=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These plots show that a greater proportion of Female passengers survived than Male, but there were far fewer Female passengers overall. For Age, the number of Children appears very (surprisingly?) small and seem to be roughly equally likely to survive or not. The majority of Adults did not survive.</p>
<p>Features of composite barplots:</p>
<ul>
<li><strong>Stacked barplots</strong> can be useful to indicate something about the relative composition of each bar in terms of any subgroups within each bar</li>
<li><strong>Grouped barplots</strong> are more effective to compare sizes of subgroups across different categories and bars</li>
<li>When the <strong>totals within the bars differ substantially</strong>, they become difficult to read</li>
<li>To adequately compare <strong>proportions</strong>, we would have to <strong>rescale</strong> each bar to have the same overall height.</li>
</ul>
</section>
<section id="mosaic-plots" class="level3">
<h3 class="anchored" data-anchor-id="mosaic-plots">Mosaic plots</h3>
<p>A <strong>mosaic plot</strong> is a modification of a stacked barplot which rescales the bars to be the same height so we can focus on the proportions of the subgroups. It also allows the <em>width</em> of the bar to vary. For example, the mosaic plot of Survived by Sex looks like this:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Sex<span class="sc">+</span>Survived, titanic), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Before we try and interpret the plot, it is helpful to understand a little about how it was constructed. The general algorithm is as follows:</p>
<ul>
<li>Begin with an empty rectangle to represent the data set</li>
<li>Take the first variable, and divide the horizontal axis into sections proportional to the sizes of its categories.</li>
<li>Take each column, and divide it into rectangles vertically according to the size of the second variable categories.</li>
<li>Continue as needed, splitting each tile alternately horizontally and vertically</li>
</ul>
<p>So, the plot we have generated has columns with widths proportional to the numbers of the two Sexes of passengers. As there were more Male passengers than Female, the Male column is wider. The columns are then split into tiles according to the proportion of each Sex that Survived or did not, with the Green area of each representing the proportion which Survived. If the two Sexes had the same rate of survival, then the two columns would split into similarly sized rows. What we see here is a substantial imbalance in the heights of the rows which is indicative of an association. Female survival rates were much better than the Male survival rate, so there’s an association between Sex and Survived.</p>
<p>In general, this functions just like a stacked barplot where we stretch each bar to have the same height. The main advantage of these plots comes when we have more than two variables to explore.</p>
<p>Did Class affect Survival?</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(Freq<span class="sc">~</span>Class<span class="sc">+</span>Survived, titanic), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we said above, if there was no effect of Class then we would expect the four bars would divide equally for each Class as the same proportion of passengers would have survived or not irrespective of Class. Clearly, the bars do not divide equally and again we have signs of an association. We can see that 1st class passengers had far better survival rates, followed by 2nd class, and 3rd class passengers didn’t fare much better than the Crew.</p>
</section>
</section>
<section id="example-arthritis-treatment" class="level2">
<h2 class="anchored" data-anchor-id="example-arthritis-treatment">Example: Arthritis Treatment</h2>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vcd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: grid</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Arthritis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The arthritis data contains the results from a double-blind clinical trial investigating a new treatment for rheumatoid arthritis. The data set contains observations on 84 patients with variables:</p>
<ul>
<li><em>ID</em> - patient ID.</li>
<li><em>Treatment</em> - factor indicating treatment (Placebo, Treated).</li>
<li><em>Sex</em> - factor indicating sex (Female, Male).</li>
<li><em>Age</em> - age of patient.</li>
<li><em>Improved</em> - ordered factor indicating treatment outcome (None, Some, Marked).</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Arthritis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID Treatment  Sex Age Improved
1 57   Treated Male  27     Some
2 46   Treated Male  29     None
3 77   Treated Male  30     None
4 17   Treated Male  32   Marked
5 36   Treated Male  46   Marked
6 23   Treated Male  58   Marked</code></pre>
</div>
</div>
<p><code>Treatment</code>, <code>Sex</code>, and <code>Improved</code> are all nominal categorical variables. Improved is <code>ordinal</code>, since the category levels can be placed in a meaningful order. The question is whether the patient <code>Improvement</code> depends on <code>Treatment</code> and/or <code>Sex</code>.</p>
<p>A mosaic plot of a single variable is basically a simple stacked barplot with only one bar. Looking at the patient improvement only gives:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>Improved, Arthritis), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>,<span class="st">'#2297E6'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, no improvement is most common, but of the two groups which do have an improvement the improvement is more likely to be <code>Marked</code> than <code>Some</code>. Of course, we could just get this from a simple summary table:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(<span class="sc">~</span>Improved, Arthritis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Improved
  None   Some Marked 
    42     14     28 </code></pre>
</div>
</div>
<p>We can now start splitting things up by Treatment type. The data used to construct the plot is the 2-way contingency table, obtained by summarising the data:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(<span class="sc">~</span>Treatment<span class="sc">+</span>Improved, Arthritis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Improved
Treatment None Some Marked
  Placebo   29    7      7
  Treated   13    7     21</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>Treatment<span class="sc">+</span>Improved, Arthritis), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>,<span class="st">'#2297E6'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are a number of things to note here:</p>
<ul>
<li>The number of patients in the Placebo and Treated group appears equal, as the two columns are equal in size</li>
<li>The main outcome from the Placebo group is No Improvement - perhaps no surprise! But some patients improve anyway.</li>
<li>In the Treatment group, the most likely outcome is a Marked Improvement. An Improvement of <code>Some</code> is the least common outcome.</li>
<li>Clearly there is an association between Treatment and Improvement.</li>
</ul>
<p>For comparison, a mosaic plot with no association between Treatment and Improvement would look like this:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, in the event of no association the bars decompose into regular tiles. A loose test of this is whether we can draw a straight line from one side of the plot to the other without going through any of the tiles.</p>
<p>The order in which we introduce the variables into the mosaic plot also affects the plot we draw. Here, we have split on Treatment first and then on Improved. We could do this the other way around:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>Improved<span class="sc">+</span>Treatment, Arthritis), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>,<span class="st">'#2297E6'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we split first by <code>Improved</code>, which creates three columns that are then each split into Treatment type. This plot is most useful for showing how Improvement types decompose into Treatment groups, which is less helpful! Usually, we would split on the dependent or response variable last.</p>
<section id="more-than-two-variables" class="level3">
<h3 class="anchored" data-anchor-id="more-than-two-variables">More than two variables</h3>
<p>With more than two variables, we can still apply the same techniques to compare <strong>proportions</strong>, but it leads to two slightly different visualisations</p>
<ul>
<li>the <strong>mosaicplot</strong> plot - for more than two variables draws the plots in a (nested) grid</li>
<li>for small numbers of variables, we can look at how <strong>barplots</strong> for different levels of other variables</li>
<li>the <strong>doubledecker</strong> plot - draws a row of simple mosaic plots to compare the different levels of a third (or fourth, …) variable</li>
</ul>
<p>If we were to introduce Sex as a third variable to the mosaic plot of the Arthritis data, we will sub-divide each of the four tiles in the plots above into Male and Female halves.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>Treatment<span class="sc">+</span>Sex<span class="sc">+</span>Improved, Arthritis), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'#D9344A'</span>,<span class="st">'#1DB100'</span>,<span class="st">'#2297E6'</span>), <span class="at">main=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now the data are first split into columns by <code>Improved</code>, then each column split into rows by <code>Treatment</code>, and now further we split these tiles into smaller columns by <code>Sex</code>. This is clearly getting more complicated, but the same ideas apply. Substantial differences in sizes of tiles would suggest something is potentially going on. Possible observations we could make:</p>
<ul>
<li>The Female tiles (red) are usually wider than the Male tiles (green) - we have overall more Female patients</li>
<li>Female patients generally seem to improve more than Males, regardless of treatment</li>
<li>Treatment appears to increase the proportion of Improved patients</li>
<li>Female patients appear to improve more than Male.</li>
</ul>
</section>
<section id="doubledecker-plot" class="level3">
<h3 class="anchored" data-anchor-id="doubledecker-plot">Doubledecker plot</h3>
<p>A <strong>doubledecker</strong> plot is a particular type of mosaic plot that splits all of the tiles <em>vertically</em>, except for the last one. The doubledecker plot is a lot like a sequence of stacked barplots for combinations of the categorical variables.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vcd)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">doubledecker</span>(Improved<span class="sc">~</span>Treatment<span class="sc">+</span>Sex,<span class="at">data=</span>Arthritis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We interpret this plot in much the same way. Here the columns are divided into the Treatment groups first, then each Treatment group divided into the two Sexes. This creates four columns, that are split into proportions according to <code>Improved</code>. So, we can observe similar features to before:</p>
<ul>
<li>The Female columns are wider than the Male, suggesting more Female patients</li>
<li>The <code>Marked</code> improvement tiles in the Female columns are larger than those in the Male, suggesting Female patients response better</li>
<li>There was nobody with the combination Male + Placebo + Some Improvement. This is denoted by the hollow circle where this tile should be.</li>
</ul>
<p>If we have a particular response variable in mind, the double-decker plot is often more useful than the general mosaic as we can split the independent variables (Sex, Treatment) into columns, and split the columns by the dependent variable (Improved). Overall, we can identify the same features from both types of plots, but the information is presented differently.</p>
</section>
<section id="example-sinking-of-the-titanic-1" class="level3">
<h3 class="anchored" data-anchor-id="example-sinking-of-the-titanic-1">Example: Sinking of the Titanic</h3>
<p>Let’s return to the Titanic data and explore whether Survived depends on combinations of Sex or Class. In fact, since the scale of this problem is relatively modest. we can actually visualise the data as a matrix of barplots.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>While they show the shape of the distribution, making detailed comparisons is not terribly easy.</p>
<p><strong>How did the combination of Class and Sex affect Survival?</strong> We can incorporate more variables into the <em>doubledecker</em> plot which will highlight differences in <em>proportions</em> rather than <em>counts.</em></p>
<p>The columns are now <em>grouped by combinations</em> of Class &amp; Sex.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Female survival was still higher overall, though declined rapidly with Class.</li>
<li>Almost all Female 1st class passengers survived, though those in 3rd class were not so fortunate</li>
<li>Male survival rates don’t decline so much with Class, and Males in 2nd class have the lowest survival.</li>
</ul>
<p>An alternative presentation of the same information is a mosaic plot:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>A mosaic plot show the data in a grid, rather than row.</li>
<li>The doubledecker plot uses a fixed height for its bars, but the mosaic plot varies the height and width of the panels according to the proportions of the factor variable.</li>
<li>This can make it a bit easier to distinguish the relative sizes of the combinations.</li>
</ul>
<p>The mosaic plot algorithm is sensitive to the ordering of variables, so changing this will radically affect the plot drawn:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However all of these methods start to struggle with more than a few variables. Unfortunately, too many combinations make the plots difficult to read and introduce a lot of ‘0’ counts into the data.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture2a_ManyCatVar_files/figure-html/unnamed-chunk-23-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="connection-with-chi2-tests" class="level2">
<h2 class="anchored" data-anchor-id="connection-with-chi2-tests">Connection with <span class="math inline">\(\chi^2\)</span> tests</h2>
<p>The visualisation of Titanic data provided above suggests that there is some association here to explore. The rigorous way to assess association is through <strong><span class="math inline">\(\chi^2\)</span> tests</strong>. Here’s how they work.</p>
<section id="first-step-creating-contingency-tables" class="level3">
<h3 class="anchored" data-anchor-id="first-step-creating-contingency-tables">First step: Creating Contingency Tables</h3>
<p>First, we need to set up a general 2-way contingency table problem. Suppose that:</p>
<ul>
<li>We have observed <span class="math inline">\(n\)</span> individuals</li>
<li>We have recorded that value of two categorical variables for each:
<ul>
<li>Variable 1, which has <span class="math inline">\(C\)</span> distinct levels</li>
<li>Variable 2, which has <span class="math inline">\(R\)</span> distinct levels</li>
</ul></li>
<li>The number of individuals who are observed in level <span class="math inline">\(i\)</span> for variable 1 and level <span class="math inline">\(j\)</span> for variable 2 is called <span class="math inline">\(o_{ij}\)</span>.</li>
</ul>
<p>We can then summarise this in the 2-way table below, where the levels of variable 1 are the rows of the table, and the levels of variable 2 are the columns:</p>
<!-- |            |          |          | Variable 2 |         | ... |       |  | -->
<table class="caption-top table">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Var 1\ Var 2</th>
<th>1</th>
<th>2</th>
<th>…</th>
<th><span class="math inline">\(j\)</span></th>
<th>…</th>
<th><span class="math inline">\(C\)</span></th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>1</strong></td>
<td><span class="math inline">\(o_{11}\)</span></td>
<td><span class="math inline">\(o_{12}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{1j}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{1C}\)</span></td>
<td><span class="math inline">\(r_1\)</span></td>
</tr>
<tr class="even">
<td><strong>2</strong></td>
<td><span class="math inline">\(o_{21}\)</span></td>
<td><span class="math inline">\(o_{22}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{2j}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{2C}\)</span></td>
<td><span class="math inline">\(r_2\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\ddots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\ddots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
</tr>
<tr class="even">
<td><strong>i</strong></td>
<td><span class="math inline">\(o_{i1}\)</span></td>
<td><span class="math inline">\(o_{i2}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{ij}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{iC}\)</span></td>
<td><span class="math inline">\(r_i\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\ddots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\ddots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
</tr>
<tr class="even">
<td><strong>R</strong></td>
<td><span class="math inline">\(o_{R1}\)</span></td>
<td><span class="math inline">\(o_{R2}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{Rj}\)</span></td>
<td>…</td>
<td><span class="math inline">\(o_{RC}\)</span></td>
<td><span class="math inline">\(r_R\)</span></td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td><span class="math inline">\(c_1\)</span></td>
<td><span class="math inline">\(c_2\)</span></td>
<td>…</td>
<td><span class="math inline">\(c_j\)</span></td>
<td>…</td>
<td><span class="math inline">\(c_C\)</span></td>
<td><span class="math inline">\(n\)</span></td>
</tr>
</tbody>
</table>
<p>Here we have also introduce notation for the row and columns sums:</p>
<ul>
<li><span class="math inline">\(r_i\)</span> is the sum of counts in the <span class="math inline">\(i\)</span>th row. This corresponds to the number of observations of level <span class="math inline">\(i\)</span> of Variable 1. The collection of row counts <span class="math inline">\(r_1,\dots,r_R\)</span> corresponds to the counts for all the different levels of Variable 1.</li>
<li><span class="math inline">\(c_j\)</span> is the sum of counts in the <span class="math inline">\(j\)</span>th row. This corresponds to the number of observations of level <span class="math inline">\(j\)</span> of Variable 2. The collection of row counts <span class="math inline">\(c_1,\dots,c_C\)</span> corresponds to the counts for all the different levels of Variable 2.</li>
</ul>
<section id="contingency-tables-in-r" class="level4">
<h4 class="anchored" data-anchor-id="contingency-tables-in-r">Contingency tables in <code>R</code></h4>
<p>We can use the <code>xtabs</code> function from Lecture 1 to construct these contingency tables from data. There are two different usages, depending on whether the data has been pre-summarised as counts (like the Titanic data), or if the data is not summarised and each row corresponds to a single observation.</p>
<p>If the data is summarised already, and contains the totals in column called <code>counts</code>, then the summary of counts for the levels of <code>variable1</code> is obtained by:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(counts<span class="sc">~</span>variable1, <span class="at">data=</span>dataset)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For example, to summarise survival:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived,<span class="at">data=</span>titanic)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Survived
  No  Yes 
1490  711 </code></pre>
</div>
</div>
<p>For 2-way tables, we simply add another variable to the right of the <code>~</code> symbol:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(counts<span class="sc">~</span>variable1<span class="sc">+</span>variable2, <span class="at">data=</span>dataset)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For example, to summarise combinations of survival with class of passenger:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Class,<span class="at">data=</span>titanic)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Class
Survived 1st 2nd 3rd Crew
     No  122 167 528  673
     Yes 203 118 178  212</code></pre>
</div>
</div>
</section>
<section id="n-way-contingency-tables" class="level4">
<h4 class="anchored" data-anchor-id="n-way-contingency-tables">n-way Contingency Tables</h4>
<p>When we have <span class="math inline">\(n\)</span> categorical variables, we could create an <span class="math inline">\(n\)</span>-way contingency table. The table would summarise the counts of every possible combination of every possible level of the <span class="math inline">\(n\)</span> variables. This obviously gets more complicated with larger <span class="math inline">\(n\)</span>, but we’ll come back to this later.</p>
<p>For instance, we could summarise the combinations of Titanic passenger survival, passenger class <em>and</em> passenger sex:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Class<span class="sc">+</span>Sex, <span class="at">data=</span>titanic)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , Sex = Male

        Class
Survived 1st 2nd 3rd Crew
     No  118 154 422  670
     Yes  62  25  88  192

, , Sex = Female

        Class
Survived 1st 2nd 3rd Crew
     No    4  13 106    3
     Yes 141  93  90   20</code></pre>
</div>
</div>
<p>Now we should have a 3-dimensional table with <span class="math inline">\(2\times 4\times 2\)</span> cells! But R can only print at most 2-dimensional tables. Instead, it has given us two separate 2-way table for <code>Survived+Class</code>, one for each of <code>Sex=Male</code> (top) and <code>Sex=Female</code> (bottom). We can note here that Female passengers and crew had better survivale than their male counterparts (with a notable exception being those in 3rd class).</p>
</section>
</section>
<section id="second-step-computing-expected-counts" class="level3">
<h3 class="anchored" data-anchor-id="second-step-computing-expected-counts">Second step: Computing expected counts</h3>
<p>The key idea behind using independence as the property to verify a <span class="math inline">\(\chi^2\)</span>-test is that if two variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent, then we can write <span class="math display">\[P[X=x,Y=y]=P[X=x]P[Y=y],\]</span> or equivalently in terms of conditional probabilitiy: <span class="math display">\[P[X=x | Y=y]=P[X=x].\]</span> The second version tells us that <em>even if I were to tell you the value of Y</em>, that would not cause you to change your probability distribution for <span class="math inline">\(X\)</span>. In other words, knowing <span class="math inline">\(Y\)</span> has no influence on how we thinkg <span class="math inline">\(X\)</span> will behave - in other words, the two variables are completely unrelated.</p>
<p>The <span class="math inline">\(\chi^2\)</span>-test is a relatively simple test for assessing independence. As a running example, let’s continue with the Titanic data and investigate possible relationships between <code>Survived</code> and <code>Class</code>. The idea behind our test is as follows:</p>
<ol type="1">
<li>Using the data, we can estimate the probabilities of the different levels of <code>Survived</code> (<span class="math inline">\(p_i\)</span>) and <code>Class</code> (<span class="math inline">\(p_j\)</span>) separately using the proportions of the data observed in each category.</li>
<li>Under a hypothesis of independence, I can use the first equation above to tell me that the probability of any combination of <code>Survived</code> and <code>Class</code> is just the product of individual probabilities from the previous step, <span class="math inline">\(p_{ij}=p_i p_j\)</span>. Applying this to all combinations of categories gives me the probability for every possible combination of the two variables, <span class="math inline">\(p_{ij}\)</span>.</li>
<li>The expected number of observations in each combination of categories is obtained by multiplying the probabilities from step 2 by the sample size <span class="math inline">\(n\)</span>. This gives the <em>expected counts</em> for every combination, <span class="math inline">\(E_{ij}=np_{ij}\)</span>.</li>
<li>We can then compare our expected counts to the <em>observed</em> counts in the data, and construct a test statistic.</li>
</ol>
<p>Let’s see how this goes with our data:</p>
<p><strong>Observed counts:</strong> We observe the following counts of the different categories of <code>Survived</code> and <code>Class</code></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">No</th>
<th style="text-align: right;">Yes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1490</td>
<td style="text-align: right;">711</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">1st</th>
<th style="text-align: right;">2nd</th>
<th style="text-align: right;">3rd</th>
<th style="text-align: right;">Crew</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">325</td>
<td style="text-align: right;">285</td>
<td style="text-align: right;">706</td>
<td style="text-align: right;">885</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Observed proportions:</strong> Dividing the observed counts by the sample size (<span class="math inline">\(n=2201\)</span>) gives the proportions of the data observed in each category:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">No</th>
<th style="text-align: right;">Yes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.676965</td>
<td style="text-align: right;">0.323035</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">1st</th>
<th style="text-align: right;">2nd</th>
<th style="text-align: right;">3rd</th>
<th style="text-align: right;">Crew</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.1476602</td>
<td style="text-align: right;">0.1294866</td>
<td style="text-align: right;">0.3207633</td>
<td style="text-align: right;">0.40209</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Unsuprisingly, the more common categories are now associated with larger proportions.</p>
<p><strong>Probabilities of combinations under independence</strong> We assume the null hypothesis to be <span class="math inline">\(H_0\)</span>: survival is independent from class. Then we can say, for example:</p>
<p><span class="math display">\[P[Survived=Yes,Class=1st] = P[Survived=Yes]\times P[Class=1st],\]</span></p>
<p>and the same for all the other combinations. By multiplying our probabilities from the previous step, we can make the following probability table for the joint distribution of <code>Survived</code> and <code>Class</code> under our null hypothesis of independence:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">1st</th>
<th style="text-align: right;">2nd</th>
<th style="text-align: right;">3rd</th>
<th style="text-align: right;">Crew</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">0.0999608</td>
<td style="text-align: right;">0.0876579</td>
<td style="text-align: right;">0.2171455</td>
<td style="text-align: right;">0.2722008</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">0.0476994</td>
<td style="text-align: right;">0.0418287</td>
<td style="text-align: right;">0.1036178</td>
<td style="text-align: right;">0.1298891</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Expected counts under independence</strong> Multiplying these probabilities by the number of passengers will give us the expected number of passengers (<span class="math inline">\(E\)</span>) in each group under independence:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">1st</th>
<th style="text-align: right;">2nd</th>
<th style="text-align: right;">3rd</th>
<th style="text-align: right;">Crew</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">220.0136</td>
<td style="text-align: right;">192.93503</td>
<td style="text-align: right;">477.9373</td>
<td style="text-align: right;">599.114</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">104.9864</td>
<td style="text-align: right;">92.06497</td>
<td style="text-align: right;">228.0627</td>
<td style="text-align: right;">285.886</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="third-step-pearson-residuals-and-x2-statistic" class="level3">
<h3 class="anchored" data-anchor-id="third-step-pearson-residuals-and-x2-statistic">Third step: Pearson residuals and <span class="math inline">\(X^2\)</span>-statistic</h3>
<p>We can now compare these <em>expected</em> counts with the ones we actually <em>observed</em>. If we find big differences, then we would conclude our hypothesis of independence must be wrong and that there is evidence of some form of relationship.</p>
<p>Before we do that, however, we’ll just set this up mathematically so we can obtain a formula for our test statistic.</p>
<p>For the Titanic data problem, we can construct the test statistic using the method above and get a test statistic of <span class="math inline">\(X^2=190.46\)</span> (check!). Comparing to the <span class="math inline">\(\chi^2\)</span> distribution - this has a <span class="math inline">\(p\)</span>-value of approximately 0! So, we strongly reject the hypothesis of independence and would do so at any of the usual levels of significance. Survival of the Titanic disaser and passenger class appear to be related!</p>
<p>Having discovered an interesting relationship, a good question to ask now is: <strong>why?</strong> Why did we reject this hypothesis? What about the data seemed to be at odds with the variables being independent?</p>
<p>To answer this, we look at the <em>Pearson residuals</em> - the components inside the double sum in our test statistic. For each combination of categories, we get a value of<span class="math inline">\(\frac{(O_{ij}-E_{ij})^2}{E_{ij}}\)</span>. We can inspect those values and see what we find. In particular, large values of the residuals indicate substantial departures from the null hypothesis. The sign of the residuals indicates whether there are <span class="math inline">\(\color{red}{\text{fewer}}\)</span> (&lt;0), or <span class="math inline">\(\color{red}{\text{more}}\)</span> (&gt;0) values than expected under independence.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>1st</th>
<th>2nd</th>
<th>3rd</th>
<th>Crew</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No</td>
<td><span class="math inline">\(\color{blue}{\text{-6.608}}\)</span></td>
<td><span class="math inline">\(\color{blue}{\text{-1.867}}\)</span></td>
<td><span class="math inline">\(\color{red}{\text{2.290}}\)</span></td>
<td><span class="math inline">\(\color{red}{\text{3.019}}\)</span></td>
</tr>
<tr class="even">
<td>Yes</td>
<td><span class="math inline">\(\color{red}{\text{9.566}}\)</span></td>
<td><span class="math inline">\(\color{red}{\text{2.703}}\)</span></td>
<td><span class="math inline">\(\color{blue}{\text{-3.315}}\)</span></td>
<td><span class="math inline">\(\color{blue}{\text{-4.370}}\)</span></td>
</tr>
</tbody>
</table>
<p>Here we notice the very large values in the 1st class column - we see far <span class="math inline">\(\color{red}{\text{more}}\)</span> survivors than expected and far <span class="math inline">\(\color{red}{\text{fewer}}\)</span> fatalities. The pattern appears to be reversed for those in 3rd class and the ship’s crew. Clearly, first class passengers had far better outcomes than would be expected if the chances were equal for everyone on board.</p>
<p>Finally, there’s no real need to do this entire calculation by hand as R easily perform an independence test for a contingency table. All we need to supply is the table of observed values obtained from <code>xtabs</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>( <span class="fu">xtabs</span>(Freq<span class="sc">~</span>Survived<span class="sc">+</span>Class,<span class="at">data=</span>titanic) )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test

data:  xtabs(Freq ~ Survived + Class, data = titanic)
X-squared = 190.4, df = 3, p-value &lt; 2.2e-16</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<ol type="1">
<li>It is difficult to display <strong>large volumes</strong> of multivariate categorical data</li>
<li><strong>Start with simple plots</strong> to get to know the data structure and features, and then add complexity.</li>
<li><strong>Mosaicplots</strong> and <strong>doubledecker</strong> plots offer good methods for exploring associations between categorical variables.</li>
<li><strong>Ordering</strong> of the variables in the plot and the ordering of the categories within a variable can influence what information can be found (and how easily).</li>
<li>Using the <span class="math inline">\(\chi^2\)</span> shading can help to identify particularly unusual features.</li>
</ol>
<section id="modelling-testing" class="level2">
<h2 class="anchored" data-anchor-id="modelling-testing">Modelling &amp; Testing</h2>
<ul>
<li><strong>Contingency tables</strong> - the standard for checking the association of two categorical variables is the <span class="math inline">\(\chi^2\)</span> test based on the summary table of counts.</li>
<li><strong>Associations between categorical variables</strong> - if there are a small number of variables each with only a few categories, then log linear models could be considered.</li>
<li><strong>Binary dependent variables</strong> - for a binary (two-category) dependent variable, logistic regression is a good approach.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>