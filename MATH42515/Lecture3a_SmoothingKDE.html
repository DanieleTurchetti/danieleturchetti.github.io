<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lecture3a_smoothingkde – DEVUL Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e3b7bb8e06e71ba88653cd3334f68afa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">DEVUL Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="./Lecture1a_IntroViz.html">
 <span class="dropdown-text">Lecture 1a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture1b_Variables.html">
 <span class="dropdown-text">Lecture 1b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab1_ExplContVar.html">
 <span class="dropdown-text">Practical 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop1_CategoricalVariables.html">
 <span class="dropdown-text">Workshop 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2a_ManyCatVar.html">
 <span class="dropdown-text">Lecture 2a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2b_ManyContVar.html">
 <span class="dropdown-text">Lecture 2b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab2_ManyCatVariables.html">
 <span class="dropdown-text">Practical 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop2_DepRelAss.html">
 <span class="dropdown-text">Workshop 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3a_SmoothingKDE.html">
 <span class="dropdown-text">Lecture 3a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3b_TimeSeries.html">
 <span class="dropdown-text">Lecture 3b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab3_Smoothing.html">
 <span class="dropdown-text">Practical 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop3_TimeSeries.html">
 <span class="dropdown-text">Workshop 3</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lecture-3a---smoothing-and-kernel-denisty-estimation" id="toc-lecture-3a---smoothing-and-kernel-denisty-estimation" class="nav-link active" data-scroll-target="#lecture-3a---smoothing-and-kernel-denisty-estimation">Lecture 3a - Smoothing and Kernel Denisty Estimation</a>
  <ul class="collapse">
  <li><a href="#smoothing" id="toc-smoothing" class="nav-link" data-scroll-target="#smoothing">Smoothing</a>
  <ul class="collapse">
  <li><a href="#example-us-2008-election-polls" id="toc-example-us-2008-election-polls" class="nav-link" data-scroll-target="#example-us-2008-election-polls">Example: US 2008 Election Polls</a></li>
  <li><a href="#simple-moving-averages" id="toc-simple-moving-averages" class="nav-link" data-scroll-target="#simple-moving-averages">Simple Moving Averages</a></li>
  <li><a href="#weighted-averages" id="toc-weighted-averages" class="nav-link" data-scroll-target="#weighted-averages">Weighted averages</a></li>
  <li><a href="#local-regression-methods" id="toc-local-regression-methods" class="nav-link" data-scroll-target="#local-regression-methods">Local regression methods</a></li>
  </ul></li>
  <li><a href="#density-estimation" id="toc-density-estimation" class="nav-link" data-scroll-target="#density-estimation">Density Estimation</a>
  <ul class="collapse">
  <li><a href="#theory-the-histogram-as-a-density-estimate" id="toc-theory-the-histogram-as-a-density-estimate" class="nav-link" data-scroll-target="#theory-the-histogram-as-a-density-estimate">Theory: the histogram as a density estimate</a></li>
  <li><a href="#definition-kernel-density-estimate" id="toc-definition-kernel-density-estimate" class="nav-link" data-scroll-target="#definition-kernel-density-estimate">Definition: Kernel density estimate</a></li>
  <li><a href="#violin-plot" id="toc-violin-plot" class="nav-link" data-scroll-target="#violin-plot">Violin plot</a></li>
  <li><a href="#more-dimensions" id="toc-more-dimensions" class="nav-link" data-scroll-target="#more-dimensions">More dimensions</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="lecture-3a---smoothing-and-kernel-denisty-estimation" class="level1">
<h1>Lecture 3a - Smoothing and Kernel Denisty Estimation</h1>
<p>In this lecture we’ll introduce some new techniques to produce smooth estimates of trends and density functions, and then consider how to deal with data that change over time.</p>
<ul>
<li><strong>Smoothing</strong> - introduce smoothing as a method for producing a smoothed estimated trend.</li>
<li><strong>Kernel Density Estimation</strong> - apply the smoothing ideas to produce a smooth estimated density for our data.</li>
<li><strong>Exploring Time Series</strong> - methods for data which change over time.</li>
</ul>
<section id="smoothing" class="level2">
<h2 class="anchored" data-anchor-id="smoothing">Smoothing</h2>
<ul>
<li>When exploring the data, we usually try and avoid fitting complex models.</li>
<li>However, identifying a trend line or curve from the raw data can be helpful for emphasising obvious patterns and informing our choice of model.</li>
<li>Before exploring the data, we don’t know what kind of relationships or models to expect so we need to do things in a model-free way.</li>
<li>We use smoothing which averages out (in various ways) the noise in our data to reveal a general trend or pattern.</li>
</ul>
<section id="example-us-2008-election-polls" class="level3">
<h3 class="anchored" data-anchor-id="example-us-2008-election-polls">Example: US 2008 Election Polls</h3>
<p>The data below are from the 2008 US Presidential election and show the polling lead of Barack Obama over John McCain.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dslabs)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(polls_2008)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>polls_2008 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(polls_2008)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is definitely a <em>pattern</em> here, but it is obscured in a lot of <em>noise.</em> The pattern is clearly more complicated than a straight line, so how can we represent this?</p>
</section>
<section id="simple-moving-averages" class="level3">
<h3 class="anchored" data-anchor-id="simple-moving-averages">Simple Moving Averages</h3>
<p>A flexible approach would be to take a <em>moving average</em> of the data. If we assume that for any <span class="math inline">\(x\)</span>, the trend — ie <span class="math inline">\(\mathbb{E}[Y]\)</span> — is a constant in the vicinity of <span class="math inline">\(x\)</span>. We can estimate this value by the <em>smoothed trend</em> at any point <span class="math inline">\(x_0\)</span> as the <em>sample mean</em> of the data points close to <span class="math inline">\(x_0\)</span>. As the values of <span class="math inline">\(x_0\)</span> changes, the nearby data points change, and so the smoothed trend will adapt to the shape of the data. This will obviously be more flexible than the linear regression, but a lot will depend on our definition of “close to <span class="math inline">\(x_0\)</span>”.</p>
<section id="definition-simple-central-moving-average" class="level4">
<h4 class="anchored" data-anchor-id="definition-simple-central-moving-average"><strong>Definition</strong>: Simple (central) moving average</h4>
<p>The <em>simple (central) moving average</em> of our data <span class="math inline">\((x_1,Y_1), \dots,(x_n,Y_n)\)</span> at a new location <span class="math inline">\(x_0\)</span> is defined as <span class="math display">\[\hat{f}(x_0)=\frac{1}{N(x_0)}\sum_{x_i\in\mathcal{N}(x_0)} Y_i\]</span> where <span class="math inline">\(\mathcal{N}(x_0)\)</span> is the set of all data points in the neighbourhood of <span class="math inline">\(x_0\)</span>, and <span class="math inline">\(N(x_0)=\#\mathcal{N}(x_0)\)</span>.</p>
<p>The neighbourhood of <span class="math inline">\(x_0\)</span> is defined as <span class="math display">\[\mathcal{N}(x_0)=\left\{x_i: |x_i-x_0|&lt;h\right\}\]</span> and <span class="math inline">\(h\)</span> is the bandwidth parameter.</p>
<p>To perform a moving average smooth in R, we can use the <code>ksmooth</code> function, specifying the <code>bandwidth</code> parameter as <span class="math inline">\(h\)</span> above. The result is a list with <code>x</code> and <code>y</code> components that give the smoothed values, which can then be used to draw the smoothed curve with the <code>lines</code> function.</p>
</section>
<section id="example-us-2008-election-polls-1" class="level4">
<h4 class="anchored" data-anchor-id="example-us-2008-election-polls-1">Example: US 2008 Election Polls</h4>
<p>Using <span class="math inline">\(h=3.5\)</span> (so we average over 1 week of data at a time) we obtain:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(polls_2008<span class="sc">$</span>day, polls_2008<span class="sc">$</span>margin, <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">7</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y,<span class="at">col=</span><span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Reducing the bandwidth (<span class="math inline">\(h=3.5\)</span>) reduces the smoothness:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Increasing the bandwidth (<span class="math inline">\(h=14\)</span>) increases the smoothness:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(polls_2008<span class="sc">$</span>day, polls_2008<span class="sc">$</span>margin, <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">14</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y,<span class="at">col=</span><span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>But we must be careful not to go too far (<span class="math inline">\(h=70\)</span>):</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(polls_2008<span class="sc">$</span>day, polls_2008<span class="sc">$</span>margin, <span class="at">kernel =</span> <span class="st">"box"</span>, <span class="at">bandwidth =</span> <span class="dv">70</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fit<span class="sc">$</span>x, <span class="at">y=</span>fit<span class="sc">$</span>y,<span class="at">col=</span><span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>The <em>choice of bandwidth</em> is very influential when smoothing data.</li>
<li>If we <em>under-smooth</em>, there will still be a lot of noise in the trend.</li>
<li>If we <em>over-smooth</em>, we can average out genuine features of the data.</li>
<li>This is an immediate example of the <em>bias-variance tradeoff</em>! Under-smoothing leads to high-variance but low bias, and over-smoothing gives low variance but high bias.</li>
</ul>
</section>
</section>
<section id="weighted-averages" class="level3">
<h3 class="anchored" data-anchor-id="weighted-averages">Weighted averages</h3>
<p>The <em>downside</em> of the flexibility of the moving average models is that they can be quite volatile. As we move along the <span class="math inline">\(x\)</span> axis, <em>the data set will change</em> - with points appearing and disappearing according to our neighbourhood rule.</p>
<p>We can think of the moving average as computing the following weighted average: <span class="math display">\[\hat{f}(x_0) = \sum_{i=1}^n w_i(x_0) Y_i\]</span> with each point receiving a weight <span class="math inline">\(w_i(x_0)\)</span> of either <span class="math inline">\(0\)</span> or <span class="math inline">\(1/N_0\)</span> depending on whether we’re in the neighbourhood or not.</p>
<p>A <em>smoother</em> way to do this is to use a <em>continuous weight function</em>, to give nearer points more influence and distant points less influence.</p>
<section id="definition-kernel-smoother" class="level4">
<h4 class="anchored" data-anchor-id="definition-kernel-smoother"><strong>Definition</strong>: Kernel smoother</h4>
<p>The <em>kernel smoother</em> of our data <span class="math inline">\((x_1,Y_1), \dots,(x_n,Y_n)\)</span> at a new location <span class="math inline">\(x_0\)</span> is defined as: <span class="math display">\[\hat{f}(x_0)= \sum_{i=1}^n w_i(x_0) Y_i\]</span> where <span class="math inline">\(w_i(x_0)\)</span> is the weight of each data point <span class="math inline">\(x_i\)</span> on the point of interest <span class="math inline">\(x_0\)</span> and <span class="math inline">\(\sum\nolimits_{i=1}^n w_i=1\)</span>.</p>
<p>The weights are defined in terms of a <em>kernel function</em> <span class="math inline">\(K\)</span> which controls its shape and behaviour such that <span class="math display">\[w_i(x;h)=\frac{K\left(\frac{x-x_i}{h}\right)}{\sum\nolimits_{i=1}^nK\left(\frac{x-x_i}{h}\right)}\]</span>.</p>
</section>
<section id="definition-kernel-functions" class="level4">
<h4 class="anchored" data-anchor-id="definition-kernel-functions"><strong>Definition</strong>: Kernel functions</h4>
<p>For our purposes, the kernel function is non-negative real-valued integrable function <span class="math inline">\(K\)</span>. Typically, we also require</p>
<ul>
<li>Normalisation: <span class="math inline">\(\int K(u)~\text{d}u=1\)</span>, making <span class="math inline">\(K(\cdot)\)</span> a pdf.</li>
<li>Symmetry: <span class="math inline">\(K(u)=K(-u)\)</span> for all <span class="math inline">\(u\)</span></li>
</ul>
<p>Some examples of kernel functions:</p>
<ul>
<li><em>Gaussian</em>: <span class="math inline">\(K(u)=\phi(u)\)</span>, probably the most popular</li>
<li><em>Uniform</em>: <span class="math inline">\(K(u)=\frac{1}{2}I_{\{|u|&lt;1\}}\)</span>, gives us the simple moving average</li>
<li><em>Epanechnikov</em>: <span class="math inline">\(K(u)=\frac{3}{4}(1-u^2)I_{\{|u|&lt;1\}}\)</span>, is optimally efficient.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>We can again perform kernel smoothing using the <code>ksmooth</code> function, but by specifying the <code>kernel</code> argument we can choose the kernel function. Only the Uniform (<code>kernel="box"</code>) and Gaussian (<code>kernel="normal"</code>) options are supported.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fitN <span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(polls_2008<span class="sc">$</span>day, polls_2008<span class="sc">$</span>margin, <span class="at">kernel =</span> <span class="st">"normal"</span>, <span class="at">bandwidth =</span> <span class="dv">7</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>fitN<span class="sc">$</span>y,<span class="at">col=</span><span class="dv">4</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-us-2008-election-polls-2" class="level4">
<h4 class="anchored" data-anchor-id="example-us-2008-election-polls-2">Example: US 2008 Election Polls</h4>
<p>Our kernel smoother estimate will inherit the <em>smoothness properties</em> of the kernel.</p>
<p>For well-behaved data, the <em>choice of the kernel has little practical impact</em>, at least compared with the choice of the bandwidth.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="local-regression-methods" class="level3">
<h3 class="anchored" data-anchor-id="local-regression-methods">Local regression methods</h3>
<ul>
<li>A limitation of this weighted average approach is the assumption that the trend is approximately constant in the neighbourhood of any given point.</li>
<li>For this to make sense, we must consider small bandwidths, containing only a few data points to average, and giving noisy estimates of the trend <span class="math inline">\(\hat{f}(x)\)</span>.</li>
<li>Instead, if we assume the function is locally linear then its reasonable to consider larger window sizes and fit a local linear regression.</li>
<li>For a smooth function, we can consider a Taylor expansion to see why this is a valid approach.</li>
</ul>
<section id="definition-local-regression-by-loess" class="level4">
<h4 class="anchored" data-anchor-id="definition-local-regression-by-loess"><strong>Definition</strong>: Local Regression by LOESS</h4>
<p>To obtain the local linear fit, we use a weighted approach. Instead of using least squares, we minimise a weighted version instead: <span class="math display">\[\sum_{i=1}^N w_0(x_i) \left[Y_i-\{\beta_0+\beta_1x_i\}\right]^2.\]</span></p>
<p>The standard kernel used to produce the weights is the Tukey tri-weight <span class="math display">\[K(u)=\begin{cases}
\left(1-|u|^3\right)^3 &amp; |u|\leq 1\\
0&amp;|u|&gt;1\end{cases}\]</span> This combination of methods is known as <em>loess</em> or <em>lowess.</em></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comments-on-loess" class="level4">
<h4 class="anchored" data-anchor-id="comments-on-loess">Comments on Loess</h4>
<ul>
<li>Instead of using a bandwidth to define a neighbourhood, loess methods fix the number of points used in each local fit at a specified proportion <span class="math inline">\(\alpha\)</span> of the nearest points in the data set, known as the <em>span.</em></li>
<li>Techniques such as <em>cross-validation</em> are often used to find the ‘best’ <span class="math inline">\(\alpha\)</span>, but when just exploring the data this is probably over-kill.</li>
<li>As the linear regression changes depending on the value of <span class="math inline">\(x\)</span>, we <em>cannot extract a single model</em> for the loess fit on a given data set.</li>
</ul>
<p>To apply local regression by LOESS, we can use the <code>loess</code> function, which works much like the <code>lm</code> function does for standard regression. First we fit the model using <code>loess</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(margin<span class="sc">~</span>day, <span class="at">data=</span>polls_2008,<span class="at">span=</span><span class="fl">0.25</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can then use the <code>predict</code> functions to predict values of the smoothed trend:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">day =</span> fitN<span class="sc">$</span>x), <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The predictions can then be used to draw the smoothed trend on the plot</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span>cols[<span class="dv">1</span>],<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Adjusting the <code>span</code> argument has a similar effect to adjusting the bandwidth of the kernel smoother on the smoothness of the resulting trend:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span>cols[<span class="dv">1</span>],<span class="at">lwd=</span><span class="dv">4</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(margin<span class="sc">~</span>day, <span class="at">data=</span>polls_2008,<span class="at">span=</span><span class="fl">0.5</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">day =</span> fitN<span class="sc">$</span>x), <span class="at">se =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span>cols[<span class="dv">2</span>],<span class="at">lwd=</span><span class="dv">4</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(margin<span class="sc">~</span>day, <span class="at">data=</span>polls_2008,<span class="at">span=</span><span class="fl">0.75</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">day =</span> fitN<span class="sc">$</span>x), <span class="at">se =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span>cols[<span class="dv">3</span>],<span class="at">lwd=</span><span class="dv">4</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">'bottomright'</span>,<span class="at">col=</span>cols[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>],<span class="at">pch=</span><span class="cn">NA</span>,<span class="at">lwd=</span><span class="dv">4</span>,<span class="at">legend=</span><span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As LOESS just uses linear regressions to generate its smoothed trend, we can apply linear regression theory to obtain the standard errors of the trend and form confidence intervals around it.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>polls_2008<span class="sc">$</span>day, <span class="at">y=</span>polls_2008<span class="sc">$</span>margin,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">xlab=</span><span class="st">'Day'</span>,<span class="at">ylab=</span><span class="st">'Margin'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lfit <span class="ot">&lt;-</span> <span class="fu">loess</span>(margin<span class="sc">~</span>day, <span class="at">data=</span>polls_2008,<span class="at">span=</span><span class="fl">0.25</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>lpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lfit, <span class="fu">data.frame</span>(<span class="at">day =</span> fitN<span class="sc">$</span>x), <span class="at">se =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="at">x=</span><span class="fu">c</span>(fitN<span class="sc">$</span>x,<span class="fu">rev</span>(fitN<span class="sc">$</span>x)), <span class="at">y=</span><span class="fu">c</span>(lpred<span class="sc">$</span>fit<span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,lpred<span class="sc">$</span>df)<span class="sc">*</span>lpred<span class="sc">$</span>se,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">rev</span>(lpred<span class="sc">$</span>fit<span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,lpred<span class="sc">$</span>df)<span class="sc">*</span>lpred<span class="sc">$</span>se)),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">col=</span><span class="fu">alpha</span>(cols[<span class="dv">1</span>],<span class="fl">0.5</span>),<span class="at">border=</span><span class="cn">NA</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>fitN<span class="sc">$</span>x, <span class="at">y=</span>lpred<span class="sc">$</span>fit,<span class="at">col=</span><span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><em>Splines</em> offer a powerful alternative method for smoothing data, but we don’t have time to go into those…</li>
</ul>
</section>
</section>
</section>
<section id="density-estimation" class="level2">
<h2 class="anchored" data-anchor-id="density-estimation">Density Estimation</h2>
<ul>
<li>Smoothing and kernel methods provide a <em>flexible</em> way of <em>estimating general functions</em> of our data without needing many assumptions or complex techniques.</li>
<li>What about using them to estimate the most useful function of all - <em>the probability density function</em>?</li>
<li>This leads to an area of statistics known as <em>kernel density estimation</em>.</li>
<li>We’ve already seen the simplest method for estimating a density function - the <em>histogram</em>!</li>
</ul>
<section id="theory-the-histogram-as-a-density-estimate" class="level3">
<h3 class="anchored" data-anchor-id="theory-the-histogram-as-a-density-estimate">Theory: the histogram as a density estimate</h3>
<p>First, define the fixed <em>intervals</em> (or <em>bins</em>) of the histogram by the intervals <span class="math inline">\(\mathcal{B}_k=[a_k,a_{k+1})\)</span>, where <span class="math inline">\(a_{k+1}=a_k+h\)</span> for a <em>bin-width</em> (or <em>bandwidth</em>) <span class="math inline">\(h&gt;0\)</span>.</p>
<p>The <em>density</em> of <span class="math inline">\(X\)</span> in bin <span class="math inline">\(k\)</span> can be expressed as <span class="math display">\[f(x_0)=\lim_{h\rightarrow 0+} \frac{\mathbb{P}[a_k&lt;X&lt;a_{k}+h]}{h}.\]</span></p>
<p>An <em>unbiased estimate</em> of a probability is a <em>sample proportion</em>, so if we define the number of points in bin <span class="math inline">\(\mathcal{B}_k\)</span> as <span class="math inline">\(n_k=\#\{X_i:X\in[a_k,a_{k+1})\}\)</span> then our histogram estimate of the density above can be written as <span class="math display">\[\hat{f}_\text{hist}(x_0)=\frac{1}{h}\hat{\mathbb{P}}[a_k&lt;X&lt;a_{k}+h]=\frac{1}{h}\frac{n_k}{n}\]</span></p>
<p>With a bit more theory (and glossing over some details), we can show that for an <span class="math inline">\(x\in\mathcal{B}_k\)</span>:</p>
<ol type="1">
<li>If <span class="math inline">\(h\rightarrow 0\)</span>, then <span class="math inline">\(\mathbb{E}\left[\hat{f}_\text{hist}(x)\right]\rightarrow f(x)\)</span> - so we <em>reduce bias</em> by reducing <span class="math inline">\(h\)</span></li>
<li><span class="math inline">\(\mathbb{V}\text{ar}\left[\hat{f}_\text{hist}(x)\right]=\frac{f(x)[1-hf(x)]}{nh}\)</span>, so if <span class="math inline">\(h\rightarrow 0\)</span> then the <em>variance increases</em>!</li>
<li>We can also reduce the <em>variance</em> by letting <span class="math inline">\(n\rightarrow\infty\)</span>.</li>
</ol>
<p>We have another <em>bias-variance tradeoff</em>, and another problem very sensitive to the <em>choice of bandwidth</em>!</p>
<section id="example-velocity-of-galaxies" class="level4">
<h4 class="anchored" data-anchor-id="example-velocity-of-galaxies">Example: Velocity of Galaxies</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(galaxies)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>galaxies <span class="ot">&lt;-</span> galaxies<span class="sc">/</span><span class="dv">1000</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Plotted below are four histograms of the velocities in km/sec of 82 galaxies from 6 well-separated conic sections of an unfilled survey of the Corona Borealis region. The sensitivity of the histogram estimate of the density to the bin-width is clear, with the top-left plot showing a lot of structure but also a lot of noise. The bottom-right plot is clearly over-smoothed, with many of the data features obscured resulting in a high bias.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(galaxies,<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">9</span>,<span class="dv">35</span>,<span class="at">by=</span><span class="fl">0.5</span>),<span class="at">xlab=</span><span class="st">'Velocity'</span>,<span class="at">freq=</span><span class="cn">FALSE</span>,<span class="at">main=</span><span class="st">'h=0.5'</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(galaxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(galaxies,<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">9</span>,<span class="dv">35</span>,<span class="at">by=</span><span class="dv">2</span>),<span class="at">xlab=</span><span class="st">'Velocity'</span>,<span class="at">freq=</span><span class="cn">FALSE</span>,<span class="at">main=</span><span class="st">'h=2'</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(galaxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(galaxies,<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">9</span>,<span class="dv">39</span>,<span class="at">by=</span><span class="dv">5</span>),<span class="at">xlab=</span><span class="st">'Velocity'</span>,<span class="at">freq=</span><span class="cn">FALSE</span>,<span class="at">main=</span><span class="st">'h=5'</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(galaxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-16-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(galaxies,<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">9</span>,<span class="dv">39</span>,<span class="at">by=</span><span class="dv">10</span>),,<span class="at">xlab=</span><span class="st">'Velocity'</span>,<span class="at">freq=</span><span class="cn">FALSE</span>,<span class="at">main=</span><span class="st">'h=10'</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(galaxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-16-4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="theoretical-properties-of-the-histogram" class="level4">
<h4 class="anchored" data-anchor-id="theoretical-properties-of-the-histogram">Theoretical properties of the histogram</h4>
<p>Like the <em>simple moving average</em>, the <em>histogram</em> suffers a lot of similar issues as an estimate for a density function:</p>
<ul>
<li>The shape of the estimate is <em>very sensitive to the choice of bin-width (or bandwidth)</em></li>
<li>The fixed and rigid intervals include variable numbers of points, giving <em>variable levels of accuracy</em></li>
<li>Most importantly, we’re using something <em>non-smooth</em> (i.e.&nbsp;bars which are constant in their interval) to estimate a smooth function!</li>
</ul>
</section>
</section>
<section id="definition-kernel-density-estimate" class="level3">
<h3 class="anchored" data-anchor-id="definition-kernel-density-estimate">Definition: Kernel density estimate</h3>
<p>The kernel density estimate of a probability density function <span class="math inline">\(f(x)\)</span> from data <span class="math inline">\(X_1,\dots,X_n\)</span> is defined as <span class="math display">\[\hat{f}_K(x;h)=\frac{1}{nh}\sum_{i=1}^n K\left(\frac{x-X_i}{h}\right),\]</span> where <span class="math inline">\(h\)</span> is the bandwidth, and <span class="math inline">\(K(\cdot)\)</span> is a kernel function.</p>
<p>The histogram estimator for bin <span class="math inline">\(k\)</span> can be expressed in this form: <span class="math inline">\(\hat{f}_\text{hist}(x;h)=\frac{1}{nh}\sum_{i=1}^n  \mathbf{I}\{X_i\in\mathcal{B}_k\}\)</span></p>
<p>The plot below illustrates the kernel density estimate. We begin with data points (left), each data point then makes a contribution to the density function estimate according to the kernel function (middle), the contributions are then averaged and we obtain the smooth density estimate (right).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
</div>
<p>As the bandwidth affects the kernel width and hence the distance over which each data point influences the density estimate, the effect of bandwidth on the shape of the final KDE is quite strong:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
</div>
<p>For density estimates, the shape of the kernel has a much stronger impact on the smoothness of the estimated density:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/moo-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
</div>
<section id="theoretical-properties-of-the-kde" class="level4">
<h4 class="anchored" data-anchor-id="theoretical-properties-of-the-kde">Theoretical properties of the KDE</h4>
<p>We can (but we won’t) derive the theoretical properties of the KDE and find very similar results to those seen earlier:</p>
<ul>
<li><span class="math inline">\(\text{bias}\left[\hat{f}_K(x),f(x)\right]\rightarrow 0\)</span> as <span class="math inline">\(h\rightarrow 0\)</span> — <em>bias is reduced for smaller bandwidths</em></li>
<li><span class="math inline">\(\mathbb{V}\text{ar}\left[\hat{f}_K(x)\right]\rightarrow\infty\)</span> as <span class="math inline">\(h\rightarrow 0\)</span> — <em>variance increases for smaller bandwidths</em></li>
<li>But <span class="math inline">\(\mathbb{V}\text{ar}\left[\hat{f}_K(x)\right]\rightarrow0\)</span> if <span class="math inline">\(nh\rightarrow\infty\)</span> — small bandwidths are <em>okay so long as <span class="math inline">\(n\)</span> is big enough!</em></li>
</ul>
<p>The problem of identifying the ‘best’ <span class="math inline">\(h\)</span> is called <em>bandwidth selection</em> and is a substantial area in itself.</p>
</section>
<section id="example-velocity-of-galaxies-1" class="level4">
<h4 class="anchored" data-anchor-id="example-velocity-of-galaxies-1">Example: Velocity of Galaxies</h4>
<p>The <code>density</code> function can perform kernel density estimation and is used in a similar way to <code>ksmooth</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">density</span>(galaxies, <span class="at">bw=</span><span class="fl">0.25</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Again, the result is a list with <code>x</code> and <code>y</code> components that give the smoothed densities, which can then be used to draw the smoothed curve with the <code>lines</code> function. If the bandwidth (<code>bw</code>) is not specified, R will try and estimate it.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span><span class="fu">range</span>(galaxies),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.25</span>),<span class="at">ty=</span><span class="st">'n'</span>,<span class="at">ylab=</span><span class="st">'Density'</span>,<span class="at">xlab=</span><span class="st">'Velocity'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(galaxies)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">density</span>(galaxies,<span class="at">bw=</span><span class="fl">0.25</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d<span class="sc">$</span>x,<span class="at">y=</span>d<span class="sc">$</span>y, <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">density</span>(galaxies,<span class="at">bw=</span><span class="fl">0.5</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d<span class="sc">$</span>x,<span class="at">y=</span>d<span class="sc">$</span>y, <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">density</span>(galaxies,<span class="at">bw=</span><span class="dv">1</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d<span class="sc">$</span>x,<span class="at">y=</span>d<span class="sc">$</span>y, <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="dv">4</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">density</span>(galaxies,<span class="at">bw=</span><span class="dv">3</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>d<span class="sc">$</span>x,<span class="at">y=</span>d<span class="sc">$</span>y, <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="dv">5</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">'topright'</span>,<span class="at">legend=</span><span class="fu">paste0</span>(<span class="st">'h='</span>,<span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">3</span>)),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,<span class="at">pch=</span><span class="cn">NA</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="violin-plot" class="level3">
<h3 class="anchored" data-anchor-id="violin-plot">Violin plot</h3>
<p>We’ve seen how we can use density estimation to produce a “smooth” histogram for a variable. We can also combine this idea with a boxplot, to produce a <strong>violin plot</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(galaxies), <span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span>,<span class="at">y =</span> galaxies)) <span class="sc">+</span> <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>, <span class="at">color =</span> <span class="st">"#473e2c"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The syntax is rather complicated here, as we’re relying on the <code>ggplot</code> package. GGPlot has a somewhat different syntax than standard R (which is why we didn’t focus on it), but it can be very effective and versatile. Once you get the hang of it!</p>
<p>The <strong>violin plot</strong> functions something like a combination of box plot and histogram. We get the same sort of information on the shape of the distribution that we do with the smoothed histogram, but the simplicity and handling of outliers from box plots is lost.</p>
<p>Nevertheless, the violin plot is most effective when comparing distributions across multiple sub-groups of the data.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chickwts)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(feed), <span class="at">y =</span> weight)) <span class="sc">+</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>, <span class="at">adjust=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Feed Supplement"</span>, <span class="at">y =</span> <span class="st">"Chick Weight (g)"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In comparison to the boxplots, we get a lot more information on the shape of the distributions.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chickwts)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(feed), <span class="at">y =</span> weight)) <span class="sc">+</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_violin</span>(<span class="at">fill =</span> <span class="st">"lightBlue"</span>, <span class="at">adjust=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">width=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Feed Supplement"</span>, <span class="at">y =</span> <span class="st">"Chick Weight (g)"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <strong>ridgeline</strong> plot is used in similar circumstances, but shows the densities <em>horizontally</em> in a series of ridges.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(chickwts, <span class="fu">aes</span>(weight, <span class="at">y=</span><span class="fu">factor</span>(feed), <span class="at">fill=</span>feed)) <span class="sc">+</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">scale =</span> <span class="fl">1.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 24.4</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="more-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="more-dimensions">More dimensions</h3>
<p>The ideas of density estimation can be extended beyond one dimension. If we consider two variables at once, then we can estimate their 2-D joint distribution as a smoothed version of a scatterplot. This also provides another alternative method of dealing with overplotting of dense data sets.</p>
<p>We can fit the 2-D density using the kde2d function from the MASS package. Let’s apply this to the Old Faithful data set:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>k1 <span class="ot">&lt;-</span> <span class="fu">kde2d</span>(geyser<span class="sc">$</span>duration, geyser<span class="sc">$</span>waiting, <span class="at">n=</span><span class="dv">100</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note that we need both an x and a y variable now, as we’re working in 2-dimension. We can set a bandwidth by supplying an <code>h</code> parameter, but this is now a vector specifying a bandwidth for the x and y directions separately.</p>
<p>The output of kde2d is a list with <code>x</code>, <code>y</code>, and <code>z</code> components. The <code>x</code> and <code>y</code> are the values of the specified variables used to create a grid of points. The density value at every combination of <code>x</code> and <code>y</code> is then estimated and returned in the <code>z</code> component. The value of <code>n</code> here indicates the number of grid points along each axis.</p>
<p>Having estimated the 2-D density, we’ll need some new functions to visualise it. A contour plot is one option:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(k1, <span class="at">col=</span><span class="st">'blue'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Though without the data, this is a bit hard to understand. So let’s overlay the contours on a scatterplot:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>geyser<span class="sc">$</span>duration, <span class="at">y=</span>geyser<span class="sc">$</span>waiting, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">xlab=</span><span class="st">'duration'</span>, <span class="at">ylab=</span><span class="st">'waiting'</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(k1, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Our 2-D density function for these data appears to detect three separate modes - one for the short duration eruptions, and two groups for the longer durations.</p>
<p>We could also generate a heat map of the density values</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(k1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice the pixelated quality of the plot. This is down to the choice of <code>n</code> when calling <code>kde2d</code>. If <code>n</code> is too small, we don’t produce enough predictions to generate a cleaner plot, so if we increase <code>n</code> this should improve. Note that this is not the same as the smoothing performed by KDE which is controlled by the bandwidth parameter <code>h</code> - this is purely a visual thing.</p>
<p>Let’s boost the value of <code>n</code> and overlay the points on the plot.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">kde2d</span>(geyser<span class="sc">$</span>duration, geyser<span class="sc">$</span>waiting, <span class="at">n =</span> <span class="dv">500</span>), <span class="at">xlab=</span><span class="st">'duration'</span>, <span class="at">ylab=</span><span class="st">'waiting'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x=</span>geyser<span class="sc">$</span>duration, <span class="at">y=</span>geyser<span class="sc">$</span>waiting, <span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture3a_SmoothingKDE_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When we have extremely large numbers of points (e.g.&nbsp;millions), drawing a scatterplot can be a slow process as each point has to be drawn individually and inevitably a large amount of over-plotting occurs. In such cases, it is often better to skip the scatterplot and look at heatmaps or contour plots of the data instead</p>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<ol type="1">
<li><strong>Smoothing</strong> is an effective technique for <strong>estimating a trend</strong> of a data set without requiring complex modelling.</li>
<li><strong>Kernel density estimation</strong> does a similar job for <strong>estimating the density function </strong>of a variable.</li>
<li>Both techniques are sensitive to their <strong>kernel function</strong>, and <strong>bandwidth</strong> parameter.</li>
<li>All of these techniques can be used to <strong>enhance</strong> data visualisations.</li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>