<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lecture5_pca – DEVUL Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e3b7bb8e06e71ba88653cd3334f68afa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">DEVUL Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="./Lecture1a_IntroViz.html">
 <span class="dropdown-text">Lecture 1a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture1b_Variables.html">
 <span class="dropdown-text">Lecture 1b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab1_ExplContVar.html">
 <span class="dropdown-text">Practical 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop1_CategoricalVariables.html">
 <span class="dropdown-text">Workshop 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2a_ManyCatVar.html">
 <span class="dropdown-text">Lecture 2a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture2b_ManyContVar.html">
 <span class="dropdown-text">Lecture 2b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab2_ManyCatVariables.html">
 <span class="dropdown-text">Practical 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop2_DepRelAss.html">
 <span class="dropdown-text">Workshop 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3a_SmoothingKDE.html">
 <span class="dropdown-text">Lecture 3a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture3b_TimeSeries.html">
 <span class="dropdown-text">Lecture 3b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab3_Smoothing.html">
 <span class="dropdown-text">Practical 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop3_TimeSeries.html">
 <span class="dropdown-text">Workshop 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture4a_CompDataQual.html">
 <span class="dropdown-text">Lecture 4a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture4b_MissingData.html">
 <span class="dropdown-text">Lecture 4b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab4_MissingData.html">
 <span class="dropdown-text">Practical 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop4_AdvancedFunctions.html">
 <span class="dropdown-text">Workshop 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture5_PCA.html">
 <span class="dropdown-text">Lecture 5a</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lecture5_PCA.html">
 <span class="dropdown-text">Lecture 5b</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Lab5_PCA.html">
 <span class="dropdown-text">Practical 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Workshop5_PCA.html">
 <span class="dropdown-text">Workshop 5</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#principal-component-analysis" id="toc-principal-component-analysis" class="nav-link active" data-scroll-target="#principal-component-analysis">Principal Component Analysis</a>
  <ul class="collapse">
  <li><a href="#unsupervised-learning" id="toc-unsupervised-learning" class="nav-link" data-scroll-target="#unsupervised-learning">Unsupervised learning</a></li>
  <li><a href="#dimensionality-reduction" id="toc-dimensionality-reduction" class="nav-link" data-scroll-target="#dimensionality-reduction">Dimensionality Reduction</a></li>
  <li><a href="#proportion-of-variance" id="toc-proportion-of-variance" class="nav-link" data-scroll-target="#proportion-of-variance">Proportion of variance</a>
  <ul class="collapse">
  <li><a href="#possible-issues" id="toc-possible-issues" class="nav-link" data-scroll-target="#possible-issues">Possible issues</a></li>
  <li><a href="#scaling-the-original-data" id="toc-scaling-the-original-data" class="nav-link" data-scroll-target="#scaling-the-original-data">Scaling the original data</a></li>
  </ul></li>
  <li><a href="#pca-using-prcomp" id="toc-pca-using-prcomp" class="nav-link" data-scroll-target="#pca-using-prcomp">PCA using <code>prcomp()</code></a>
  <ul class="collapse">
  <li><a href="#us-senate-data" id="toc-us-senate-data" class="nav-link" data-scroll-target="#us-senate-data">Us Senate data</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="principal-component-analysis" class="level1">
<h1>Principal Component Analysis</h1>
<section id="unsupervised-learning" class="level2">
<h2 class="anchored" data-anchor-id="unsupervised-learning">Unsupervised learning</h2>
<p>The main two types of statistical learning are: * <strong>Supervised learning</strong>, which is “learning with a teacher”: the student present an estimate response for each observation, the teacher provides the correct answer and the student improves their models. * <strong>Unsupervised learning</strong>, which is “learning without a teacher”. In this respect, it is more challenging (no training, no validation, no simple goal). But sometimes you can’t avoid using it!</p>
<p>Unsupervised learning is often overlooked, but it has many applications: recommender systems, document search, fake image analysis, risk management, …</p>
</section>
<section id="dimensionality-reduction" class="level2">
<h2 class="anchored" data-anchor-id="dimensionality-reduction">Dimensionality Reduction</h2>
<p>Dimensionality reduction methods aim to reduce the number of variables, retaining much of the properties of the original data. They are used to * Improve storage and computational complexity * Prevent overfitting in data analysis * Reduce noise and detecting anomalies The most important technique for dimensionality reduction is principal component analysis (PCA).</p>
<p>For a description of how to define the principal components and the related quantities, please refer to the slides or to the very readable chapter 12 of <em>An introduction to statistical learning</em> (by James, Witten, Hastie and Tibshirani).</p>
<p>Here below, we discuss how to use PCA for dimensionality reduction.</p>
</section>
<section id="proportion-of-variance" class="level2">
<h2 class="anchored" data-anchor-id="proportion-of-variance">Proportion of variance</h2>
<p>We want to establish a technique to select the more relevant <span class="math inline">\(PC_k\)</span>, to minimize loss of information when we reduce the dimension. So our main question is how to measure the amount of structure captured by each <span class="math inline">\(PC_k\)</span>.</p>
<p>The <strong>proportion of variance</strong> is what we need to use here. Recall that the variance explained by <span class="math inline">\(\phi_k\)</span> is</p>
<p>[_k = _k^T _k,]</p>
<p>which is exactly the <strong><span class="math inline">\(k\)</span>-th eigenvalue of <span class="math inline">\(\mathbf{\Sigma}\)</span></strong>.</p>
<p>The <em>proportion of variance</em> explained by <span class="math inline">\(\phi_k\)</span> is then</p>
<p>[ .]</p>
<p>A good dimension reduction technique must retain at least 80% of the original variance, as a rule of thumb. In some situations, this might be replaced by <strong>elbow rule</strong>.</p>
<section id="possible-issues" class="level3">
<h3 class="anchored" data-anchor-id="possible-issues">Possible issues</h3>
<p>The procedure always works well in theory, but presents some issues when looking at data in real life.</p>
<ul>
<li><p>If the original variables are highly uncorrelated, we need too many principal components to explain at least 80% of variance</p></li>
<li><p>By changing units of measurement, the variances also change, for the very same data!</p></li>
<li><p>Even when the units are the same, the standard deviation of the original variables can vary a lot (e.g.&nbsp;Iris data): the variables with higher standard deviation will be more represented in the first PCs.</p></li>
</ul>
<p>Issue 1 is structural, so no solution can be found. Issues 2 and 3 can be solved by scaling the data set.</p>
</section>
<section id="scaling-the-original-data" class="level3">
<h3 class="anchored" data-anchor-id="scaling-the-original-data">Scaling the original data</h3>
<p>Let <span class="math inline">\(\mathbf{X}\)</span> be the matrix of a data set. Scaling <span class="math inline">\(\mathbf{X}\)</span> means replacing each column <span class="math inline">\(\mathbf{X}\)</span> of <span class="math inline">\(\mathbf{X}\)</span> with</p>
<p>[ ,] where <span class="math inline">\(\mathbf{\mu} = \begin{pmatrix}
\mu \\
\mu\\
\vdots \\
\mu
\end{pmatrix}\)</span> is the mean vector of <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(sd\)</span> is the standard deviation of <span class="math inline">\(\mathbf{X}\)</span>.</p>
<p>The covariance matrix of the scaled data is called the <em>correlation matrix</em> of the original data.</p>
<p>Other relevant notions for PCA are:</p>
<ul>
<li><em>Correlation between PC and original variables</em>: these are obtained as dot products of the loadings against the PCs</li>
<li><em>Quality of representation</em> (cos2):</li>
<li><em>Absolute contributions</em> (contrib):</li>
</ul>
</section>
</section>
<section id="pca-using-prcomp" class="level2">
<h2 class="anchored" data-anchor-id="pca-using-prcomp">PCA using <code>prcomp()</code></h2>
<p>Now that we are backed by the theory, let’s explore once again how to perform PCA with R. We will analyze the US Senate data sets, reduce its dimension in an appropriate way and see what this analysis tells us about the evolution of political parties in the US.</p>
<section id="us-senate-data" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="us-senate-data">Us Senate data</h3>
<p>You can download the data sets from Blackboard as .csv files.</p>
<p>We first start by loading the datasets in our environment together with the libraries.</p>
<div class="cell" data-warnings="false">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("factoextra")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome! Want to learn more? See two factoextra-related books at https://goo.gl/ve3WBa</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>data07 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"senate-2007.csv"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data17 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"senate-2017.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then select only the numeric features:</p>
<div class="cell" data-warnings="false">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>data07N <span class="ot">&lt;-</span> data07 <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_if</span>(is.numeric)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>data17N <span class="ot">&lt;-</span> data17 <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_if</span>(is.numeric)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>First of all, note that you can’t check the correlation matrix from a plot matrix, as it is just too big! We can try to visualize the matrix with a color plot:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Sigma07 <span class="ot">&lt;-</span> <span class="fu">cov</span>(data07N)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>Sigma17 <span class="ot">&lt;-</span> <span class="fu">cov</span>(data17N)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">t</span>(Sigma07), <span class="at">main =</span> <span class="st">"Covariance matrix 07"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">t</span>(Sigma17), <span class="at">main =</span> <span class="st">"Covariance matrix 17"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture5_PCA_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is at least some redundancy in the data, which makes it worthwhile to try PCA. In the second plot this is more evident, so we might guess that PCA will be even more effective there.</p>
<p>/ Let us get the principal components using <em>prcomp()</em>. There is an argument to be made in favor of not to scaling the data: high variance in an observation means a higher level of disagreement in senators votes, while low variance means that most of them voted in the same way. If we care more about those issues that are more debated (e.g.&nbsp;gun laws) and less about those on which everyone agrees (e.g.&nbsp;raising senators’ salary) then it is preferable not to scale the data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pr.out07 <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(data07N)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>pr.out17 <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(data17N)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The output contains many objects</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pr.out07)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sdev"     "rotation" "center"   "scale"    "x"       </code></pre>
</div>
</div>
<p>We can check now the importance of principal components in the two cases</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pr.out07)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Importance of components:
                           PC1     PC2     PC3    PC4     PC5    PC6     PC7
Standard deviation     12.9042 3.71408 3.03882 2.4098 2.19140 2.0549 1.91235
Proportion of Variance  0.5562 0.04607 0.03084 0.0194 0.01604 0.0141 0.01221
Cumulative Proportion   0.5562 0.60225 0.63310 0.6525 0.66853 0.6826 0.69485
                           PC8     PC9    PC10   PC11    PC12    PC13    PC14
Standard deviation     1.81034 1.79620 1.77976 1.7214 1.67003 1.60616 1.56163
Proportion of Variance 0.01095 0.01078 0.01058 0.0099 0.00932 0.00862 0.00815
Cumulative Proportion  0.70580 0.71657 0.72715 0.7370 0.74637 0.75498 0.76313
                          PC15    PC16    PC17    PC18   PC19    PC20    PC21
Standard deviation     1.53252 1.51194 1.48791 1.47152 1.4476 1.40269 1.39002
Proportion of Variance 0.00784 0.00764 0.00739 0.00723 0.0070 0.00657 0.00645
Cumulative Proportion  0.77097 0.77861 0.78600 0.79324 0.8002 0.80681 0.81326
                          PC22    PC23    PC24    PC25    PC26   PC27    PC28
Standard deviation     1.35985 1.32609 1.32011 1.28057 1.27026 1.2595 1.22948
Proportion of Variance 0.00618 0.00587 0.00582 0.00548 0.00539 0.0053 0.00505
Cumulative Proportion  0.81944 0.82531 0.83113 0.83661 0.84200 0.8473 0.85234
                          PC29    PC30    PC31    PC32    PC33    PC34    PC35
Standard deviation     1.22124 1.21861 1.19118 1.16494 1.14058 1.12554 1.10577
Proportion of Variance 0.00498 0.00496 0.00474 0.00453 0.00435 0.00423 0.00408
Cumulative Proportion  0.85733 0.86229 0.86703 0.87156 0.87590 0.88013 0.88422
                          PC36    PC37    PC38    PC39   PC40    PC41    PC42
Standard deviation     1.09615 1.07222 1.06166 1.04658 1.0378 1.02996 1.00640
Proportion of Variance 0.00401 0.00384 0.00376 0.00366 0.0036 0.00354 0.00338
Cumulative Proportion  0.88823 0.89207 0.89584 0.89949 0.9031 0.90664 0.91002
                          PC43    PC44    PC45    PC46    PC47    PC48    PC49
Standard deviation     0.99843 0.98258 0.98042 0.96616 0.95144 0.94407 0.91291
Proportion of Variance 0.00333 0.00322 0.00321 0.00312 0.00302 0.00298 0.00278
Cumulative Proportion  0.91335 0.91657 0.91978 0.92290 0.92592 0.92890 0.93168
                          PC50    PC51    PC52    PC53    PC54    PC55    PC56
Standard deviation     0.90311 0.89371 0.87048 0.86888 0.85340 0.84171 0.82562
Proportion of Variance 0.00272 0.00267 0.00253 0.00252 0.00243 0.00237 0.00228
Cumulative Proportion  0.93441 0.93708 0.93961 0.94213 0.94456 0.94693 0.94920
                          PC57    PC58    PC59    PC60   PC61    PC62   PC63
Standard deviation     0.82342 0.81051 0.80683 0.79840 0.7925 0.77049 0.7552
Proportion of Variance 0.00226 0.00219 0.00217 0.00213 0.0021 0.00198 0.0019
Cumulative Proportion  0.95147 0.95366 0.95584 0.95797 0.9601 0.96205 0.9639
                          PC64    PC65    PC66    PC67    PC68    PC69    PC70
Standard deviation     0.74195 0.73172 0.72879 0.70627 0.70032 0.68822 0.67301
Proportion of Variance 0.00184 0.00179 0.00177 0.00167 0.00164 0.00158 0.00151
Cumulative Proportion  0.96579 0.96758 0.96935 0.97102 0.97266 0.97424 0.97575
                         PC71   PC72   PC73    PC74    PC75    PC76    PC77
Standard deviation     0.6712 0.6699 0.6478 0.63796 0.63142 0.61631 0.61038
Proportion of Variance 0.0015 0.0015 0.0014 0.00136 0.00133 0.00127 0.00124
Cumulative Proportion  0.9773 0.9788 0.9802 0.98152 0.98285 0.98412 0.98536
                          PC78    PC79    PC80   PC81    PC82    PC83    PC84
Standard deviation     0.59675 0.58376 0.56136 0.5481 0.53674 0.52440 0.51468
Proportion of Variance 0.00119 0.00114 0.00105 0.0010 0.00096 0.00092 0.00088
Cumulative Proportion  0.98655 0.98769 0.98874 0.9898 0.99071 0.99163 0.99251
                          PC85   PC86    PC87    PC88    PC89    PC90    PC91
Standard deviation     0.50177 0.4885 0.48019 0.45426 0.43499 0.43203 0.40844
Proportion of Variance 0.00084 0.0008 0.00077 0.00069 0.00063 0.00062 0.00056
Cumulative Proportion  0.99335 0.9941 0.99492 0.99561 0.99624 0.99686 0.99742
                          PC92    PC93    PC94    PC95    PC96    PC97    PC98
Standard deviation     0.39534 0.36208 0.35420 0.31679 0.31342 0.29432 0.27198
Proportion of Variance 0.00052 0.00044 0.00042 0.00034 0.00033 0.00029 0.00025
Cumulative Proportion  0.99794 0.99838 0.99880 0.99914 0.99946 0.99975 1.00000
                           PC99
Standard deviation     1.36e-14
Proportion of Variance 0.00e+00
Cumulative Proportion  1.00e+00</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pr.out17)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Importance of components:
                           PC1    PC2     PC3     PC4     PC5    PC6     PC7
Standard deviation     12.0503 2.9027 1.82664 1.70235 1.29058 1.2370 1.19967
Proportion of Variance  0.7686 0.0446 0.01766 0.01534 0.00882 0.0081 0.00762
Cumulative Proportion   0.7686 0.8132 0.83089 0.84623 0.85505 0.8631 0.87077
                           PC8     PC9    PC10    PC11    PC12    PC13    PC14
Standard deviation     1.11374 1.07762 1.05381 1.03398 1.01148 0.95085 0.91687
Proportion of Variance 0.00657 0.00615 0.00588 0.00566 0.00542 0.00479 0.00445
Cumulative Proportion  0.87733 0.88348 0.88936 0.89502 0.90043 0.90522 0.90967
                          PC15    PC16    PC17    PC18    PC19   PC20    PC21
Standard deviation     0.89851 0.86111 0.84270 0.81861 0.81776 0.7896 0.77534
Proportion of Variance 0.00427 0.00393 0.00376 0.00355 0.00354 0.0033 0.00318
Cumulative Proportion  0.91394 0.91787 0.92163 0.92517 0.92871 0.9320 0.93520
                         PC22    PC23    PC24    PC25    PC26    PC27    PC28
Standard deviation     0.7404 0.73203 0.71876 0.70269 0.67188 0.65235 0.64574
Proportion of Variance 0.0029 0.00284 0.00273 0.00261 0.00239 0.00225 0.00221
Cumulative Proportion  0.9381 0.94093 0.94367 0.94628 0.94867 0.95092 0.95313
                          PC29    PC30    PC31    PC32   PC33    PC34    PC35
Standard deviation     0.63316 0.62168 0.60849 0.60280 0.5667 0.56380 0.55342
Proportion of Variance 0.00212 0.00205 0.00196 0.00192 0.0017 0.00168 0.00162
Cumulative Proportion  0.95525 0.95730 0.95926 0.96118 0.9629 0.96456 0.96619
                          PC36   PC37    PC38    PC39    PC40    PC41    PC42
Standard deviation     0.55231 0.5329 0.52293 0.51992 0.50170 0.49733 0.48640
Proportion of Variance 0.00161 0.0015 0.00145 0.00143 0.00133 0.00131 0.00125
Cumulative Proportion  0.96780 0.9693 0.97075 0.97218 0.97351 0.97482 0.97608
                          PC43    PC44    PC45    PC46    PC47    PC48    PC49
Standard deviation     0.48504 0.48082 0.46988 0.46212 0.44674 0.43645 0.43040
Proportion of Variance 0.00125 0.00122 0.00117 0.00113 0.00106 0.00101 0.00098
Cumulative Proportion  0.97732 0.97855 0.97971 0.98084 0.98190 0.98291 0.98389
                          PC50    PC51    PC52   PC53    PC54    PC55    PC56
Standard deviation     0.41828 0.40480 0.39884 0.3895 0.38140 0.37360 0.36564
Proportion of Variance 0.00093 0.00087 0.00084 0.0008 0.00077 0.00074 0.00071
Cumulative Proportion  0.98482 0.98568 0.98652 0.9873 0.98810 0.98884 0.98954
                          PC57    PC58    PC59    PC60    PC61    PC62    PC63
Standard deviation     0.35721 0.35284 0.34250 0.32554 0.32372 0.32072 0.30358
Proportion of Variance 0.00068 0.00066 0.00062 0.00056 0.00055 0.00054 0.00049
Cumulative Proportion  0.99022 0.99088 0.99150 0.99206 0.99262 0.99316 0.99365
                          PC64    PC65    PC66    PC67    PC68    PC69    PC70
Standard deviation     0.30149 0.28769 0.28589 0.27252 0.26746 0.25620 0.25116
Proportion of Variance 0.00048 0.00044 0.00043 0.00039 0.00038 0.00035 0.00033
Cumulative Proportion  0.99413 0.99457 0.99500 0.99539 0.99577 0.99612 0.99645
                          PC71   PC72    PC73    PC74    PC75    PC76   PC77
Standard deviation     0.24160 0.2385 0.22971 0.21421 0.20824 0.20091 0.1944
Proportion of Variance 0.00031 0.0003 0.00028 0.00024 0.00023 0.00021 0.0002
Cumulative Proportion  0.99676 0.9971 0.99734 0.99759 0.99781 0.99803 0.9982
                          PC78    PC79    PC80    PC81    PC82    PC83    PC84
Standard deviation     0.19135 0.18550 0.17552 0.16872 0.16317 0.15708 0.14630
Proportion of Variance 0.00019 0.00018 0.00016 0.00015 0.00014 0.00013 0.00011
Cumulative Proportion  0.99842 0.99860 0.99877 0.99892 0.99906 0.99919 0.99930
                          PC85   PC86    PC87    PC88    PC89    PC90    PC91
Standard deviation     0.14214 0.1355 0.12813 0.12415 0.11872 0.10075 0.09239
Proportion of Variance 0.00011 0.0001 0.00009 0.00008 0.00007 0.00005 0.00005
Cumulative Proportion  0.99941 0.9995 0.99959 0.99968 0.99975 0.99980 0.99985
                          PC92    PC93    PC94    PC95    PC96    PC97
Standard deviation     0.08683 0.07978 0.07389 0.06650 0.05529 0.04076
Proportion of Variance 0.00004 0.00003 0.00003 0.00002 0.00002 0.00001
Cumulative Proportion  0.99989 0.99992 0.99995 0.99998 0.99999 1.00000
                            PC98      PC99
Standard deviation     1.156e-14 1.105e-15
Proportion of Variance 0.000e+00 0.000e+00
Cumulative Proportion  1.000e+00 1.000e+00</code></pre>
</div>
</div>
<p>In the first case, one needs 19 principal components to capture <span class="math inline">\(\geq 80\%\)</span> of variance, in the second case, it is sufficient to retain two of them! This is particularly striking, as our original set of variables contains more than 250 items! In both cases, <span class="math inline">\(PC1\)</span> captures a lot of variance, so it is something interesting to look at.</p>
<p>To convince ourselves of this, we can make a screeplot</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: gridExtra</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'gridExtra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    combine</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">fviz_eig</span>(pr.out07)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">fviz_eig</span>(pr.out17)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(plot1, plot2, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture5_PCA_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that, even in the first case, there is a big discrepancy between PC1 and the other principal components. In this case one can make an exception to the “80% rule” by noticing two things:</p>
<ul>
<li>Original variables are a lot.</li>
<li>There is a clear elbow in the screeplot: this is the point where the edges begin to flatten, and it occurs right after PC1.</li>
</ul>
<p>According to this <span style="color: red;">elbow method</span>, we can make an argument for retaining only the first principal component.</p>
<p>Even when only one principal component is deemed to be sufficient, it is worthwhile to visualize scores on a biplot, that can be slightly squeezed on the horizontal axis, if needed.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_ind</span>(pr.out07, <span class="at">label=</span><span class="cn">FALSE</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_ind</span>(pr.out17, <span class="at">label=</span><span class="cn">FALSE</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(plot1, plot2, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture5_PCA_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see a clear divide between senators on the left and on the right of the principal component. What could this represent?</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_ind</span>(pr.out07, <span class="at">col.ind =</span> data07<span class="sc">$</span>Party, <span class="at">label=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_ind</span>(pr.out17, <span class="at">col.ind =</span> data17<span class="sc">$</span>Party, <span class="at">label=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(plot1, plot2, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Lecture5_PCA_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The first principal component is a very good representation of party affiliation! From the historic comparison of the two plots, we can see that the divide between Democrats and Republicans has grown a lot between 2007 and 2017, this is an indication that polarization of senators along party lines is a phenomenon that predates the election of Donald Trump (2016).</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>