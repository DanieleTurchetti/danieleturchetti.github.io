<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Multilevel Modelling Practical 6 (Week 7) | MLM_worksheets.knit</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Multilevel Modelling Practical 6 (Week 7) | MLM_worksheets.knit" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Multilevel Modelling Practical 6 (Week 7) | MLM_worksheets.knit" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="multilevel-modelling-practical-5-week-6.html"/>
<link rel="next" href="multilevel-modelling-practical-7-week-8.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Home</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome to multilevel modelling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#including-plots"><i class="fa fa-check"></i><b>1.1</b> Including Plots</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="multilevel-modelling-practical-1-week-2.html"><a href="multilevel-modelling-practical-1-week-2.html"><i class="fa fa-check"></i><b>2</b> Multilevel Modelling Practical 1 (Week 2)</a>
<ul>
<li class="chapter" data-level="2.1" data-path="multilevel-modelling-practical-1-week-2.html"><a href="multilevel-modelling-practical-1-week-2.html#instructions-start-here"><i class="fa fa-check"></i><b>2.1</b> Instructions – start here!</a></li>
<li class="chapter" data-level="2.2" data-path="multilevel-modelling-practical-1-week-2.html"><a href="multilevel-modelling-practical-1-week-2.html#exercises-1"><i class="fa fa-check"></i><b>2.2</b> Exercises 1</a></li>
<li class="chapter" data-level="2.3" data-path="multilevel-modelling-practical-1-week-2.html"><a href="multilevel-modelling-practical-1-week-2.html#exercises-2"><i class="fa fa-check"></i><b>2.3</b> Exercises 2</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html"><i class="fa fa-check"></i><b>3</b> Multilevel Modelling Practical 2 (Week 3)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#instructions-start-here-1"><i class="fa fa-check"></i><b>3.1</b> Instructions – start here!</a></li>
<li class="chapter" data-level="3.2" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#exercises-1-1"><i class="fa fa-check"></i><b>3.2</b> Exercises 1</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#acquire-and-prepare-data"><i class="fa fa-check"></i><b>3.2.1</b> Acquire and prepare data</a></li>
<li class="chapter" data-level="3.2.2" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#exploratory-analysis"><i class="fa fa-check"></i><b>3.2.2</b> Exploratory analysis</a></li>
<li class="chapter" data-level="3.2.3" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#naive-simple-linear-regression-models"><i class="fa fa-check"></i><b>3.2.3</b> Naive simple linear regression models</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#exercise-2"><i class="fa fa-check"></i><b>3.3</b> Exercise 2</a></li>
<li class="chapter" data-level="3.4" data-path="multilevel-modelling-practical-2-week-3.html"><a href="multilevel-modelling-practical-2-week-3.html#exercise-3-if-time"><i class="fa fa-check"></i><b>3.4</b> Exercise 3 (if time)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html"><i class="fa fa-check"></i><b>4</b> Multilevel Modelling Practical 3 (Week 4)</a>
<ul>
<li class="chapter" data-level="4.1" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#instructions-start-here-2"><i class="fa fa-check"></i><b>4.1</b> Instructions – start here!</a></li>
<li class="chapter" data-level="4.2" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#exercise-1"><i class="fa fa-check"></i><b>4.2</b> Exercise 1</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#preparation-of-the-data-set"><i class="fa fa-check"></i><b>4.2.1</b> Preparation of the data set</a></li>
<li class="chapter" data-level="4.2.2" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#fitting-the-random-intercept-and-slope-model"><i class="fa fa-check"></i><b>4.2.2</b> Fitting the random intercept and slope model</a></li>
<li class="chapter" data-level="4.2.3" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#fitted-lines-by-class"><i class="fa fa-check"></i><b>4.2.3</b> Fitted lines by class</a></li>
<li class="chapter" data-level="4.2.4" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#the-intercept-only-empty-model-and-icc"><i class="fa fa-check"></i><b>4.2.4</b> The intercept-only / empty model and ICC</a></li>
<li class="chapter" data-level="4.2.5" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#the-random-intercept-model-with-covariate"><i class="fa fa-check"></i><b>4.2.5</b> The random intercept model (with covariate)</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#exercise-2-1"><i class="fa fa-check"></i><b>4.3</b> Exercise 2</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#preparation"><i class="fa fa-check"></i><b>4.3.1</b> Preparation</a></li>
<li class="chapter" data-level="4.3.2" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#the-random-intercept-model"><i class="fa fa-check"></i><b>4.3.2</b> The random intercept model</a></li>
<li class="chapter" data-level="4.3.3" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#diagnostics"><i class="fa fa-check"></i><b>4.3.3</b> Diagnostics</a></li>
<li class="chapter" data-level="4.3.4" data-path="multilevel-modelling-practical-3-week-4.html"><a href="multilevel-modelling-practical-3-week-4.html#include-a-second-fixed-effect-variable-gender"><i class="fa fa-check"></i><b>4.3.4</b> Include a second fixed effect variable: gender</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html"><i class="fa fa-check"></i><b>5</b> Multilevel Modelling Practical 4 (Week 5)</a>
<ul>
<li class="chapter" data-level="5.1" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#instructions-start-here-3"><i class="fa fa-check"></i><b>5.1</b> Instructions – start here!</a></li>
<li class="chapter" data-level="5.2" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#exercise-1-analysis-of-the-active-time-study-data-lecture-5"><i class="fa fa-check"></i><b>5.2</b> Exercise 1: Analysis of the Active Time study data (lecture 5)</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#how-important-is-group-structure-vpcs-and-iccs"><i class="fa fa-check"></i><b>5.2.1</b> How important is group structure? (VPCs and ICCs)</a></li>
<li class="chapter" data-level="5.2.2" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#three-level-model-with-explanatory-variables"><i class="fa fa-check"></i><b>5.2.2</b> Three level Model with explanatory variables</a></li>
<li class="chapter" data-level="5.2.3" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#comparison-of-empty-model-with-model-with-explanatory-variables"><i class="fa fa-check"></i><b>5.2.3</b> Comparison of empty model with model with explanatory variables</a></li>
<li class="chapter" data-level="5.2.4" data-path="multilevel-modelling-practical-4-week-5.html"><a href="multilevel-modelling-practical-4-week-5.html#further-analysis-bottom-up-approach"><i class="fa fa-check"></i><b>5.2.4</b> Further analysis (bottom up approach)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="multilevel-modelling-practical-5-week-6.html"><a href="multilevel-modelling-practical-5-week-6.html"><i class="fa fa-check"></i><b>6</b> Multilevel Modelling Practical 5 (Week 6)</a>
<ul>
<li class="chapter" data-level="6.1" data-path="multilevel-modelling-practical-5-week-6.html"><a href="multilevel-modelling-practical-5-week-6.html#instructions---start-here"><i class="fa fa-check"></i><b>6.1</b> Instructions - start here!</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="multilevel-modelling-practical-5-week-6.html"><a href="multilevel-modelling-practical-5-week-6.html#overview"><i class="fa fa-check"></i><b>6.1.1</b> Overview</a></li>
<li class="chapter" data-level="6.1.2" data-path="multilevel-modelling-practical-5-week-6.html"><a href="multilevel-modelling-practical-5-week-6.html#multilevel-modelling-with-longitudinal-data"><i class="fa fa-check"></i><b>6.1.2</b> Multilevel modelling with longitudinal data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html"><i class="fa fa-check"></i><b>7</b> Multilevel Modelling Practical 6 (Week 7)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html#instructions---start-here-1"><i class="fa fa-check"></i><b>7.1</b> Instructions - start here!</a></li>
<li class="chapter" data-level="7.2" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html#exercise-1-long-and-wide-data-shape"><i class="fa fa-check"></i><b>7.2</b> Exercise 1 (Long and wide data shape)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html#regression-vs-multilevel-analysis"><i class="fa fa-check"></i><b>7.2.1</b> Regression vs multilevel analysis</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html#exercise-2-simulation-from-the-two-level-longitudinal-model"><i class="fa fa-check"></i><b>7.3</b> Exercise 2 (simulation from the two-level longitudinal model)</a></li>
<li class="chapter" data-level="7.4" data-path="multilevel-modelling-practical-6-week-7.html"><a href="multilevel-modelling-practical-6-week-7.html#end-of-lab"><i class="fa fa-check"></i><b>7.4</b> End of lab!</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html"><i class="fa fa-check"></i><b>8</b> Multilevel Modelling Practical 7 (Week 8)</a>
<ul>
<li class="chapter" data-level="8.1" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html#instructions---start-here-2"><i class="fa fa-check"></i><b>8.1</b> Instructions - start here!</a></li>
<li class="chapter" data-level="8.2" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html#exercise-1-aids-data-example-2-from-lecture-7"><i class="fa fa-check"></i><b>8.2</b> Exercise 1 (Aids data: Example 2 from lecture 7)</a></li>
<li class="chapter" data-level="8.3" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html#exercise-2-leukaemia-data-example-3-from-lecture-7"><i class="fa fa-check"></i><b>8.3</b> Exercise 2 (Leukaemia data: Example 3 from lecture 7)</a></li>
<li class="chapter" data-level="8.4" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html#exercise-3-toxoplasmosis-data-binomial-logistic-regression"><i class="fa fa-check"></i><b>8.4</b> Exercise 3: Toxoplasmosis data (Binomial logistic regression)</a></li>
<li class="chapter" data-level="8.5" data-path="multilevel-modelling-practical-7-week-8.html"><a href="multilevel-modelling-practical-7-week-8.html#end-of-lab-1"><i class="fa fa-check"></i><b>8.5</b> ## End of lab!</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html"><i class="fa fa-check"></i><b>9</b> Multilevel Modelling Practical 8 (Week 9)</a>
<ul>
<li class="chapter" data-level="9.1" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#instructions---start-here-3"><i class="fa fa-check"></i><b>9.1</b> Instructions - start here!</a></li>
<li class="chapter" data-level="9.2" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#preliminaries"><i class="fa fa-check"></i><b>9.2</b> Preliminaries</a></li>
<li class="chapter" data-level="9.3" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#exercise-1-betablocker-data"><i class="fa fa-check"></i><b>9.3</b> Exercise 1: Betablocker data</a></li>
<li class="chapter" data-level="9.4" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#exercise-2-digging-deeper"><i class="fa fa-check"></i><b>9.4</b> Exercise 2 (digging deeper)</a></li>
<li class="chapter" data-level="9.5" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#exercise-3-optional-toxoplasmosis-data-revisited"><i class="fa fa-check"></i><b>9.5</b> Exercise 3 (optional): Toxoplasmosis data revisited</a></li>
<li class="chapter" data-level="9.6" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#summative-assessment"><i class="fa fa-check"></i><b>9.6</b> Summative assessment</a></li>
<li class="chapter" data-level="9.7" data-path="multilevel-modelling-practical-8-week-9.html"><a href="multilevel-modelling-practical-8-week-9.html#end-of-lab-2"><i class="fa fa-check"></i><b>9.7</b> ## End of lab!</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="multilevel-modelling-practical-9-week-10.html"><a href="multilevel-modelling-practical-9-week-10.html"><i class="fa fa-check"></i><b>10</b> Multilevel Modelling Practical 9 (Week 10)</a>
<ul>
<li class="chapter" data-level="10.1" data-path="multilevel-modelling-practical-9-week-10.html"><a href="multilevel-modelling-practical-9-week-10.html#dealing-with-missing-values"><i class="fa fa-check"></i><b>10.1</b> Dealing with missing values</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="multilevel-modelling-practical-6-week-7" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">7</span> Multilevel Modelling Practical 6 (Week 7)<a href="multilevel-modelling-practical-6-week-7.html#multilevel-modelling-practical-6-week-7" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="instructions---start-here-1" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Instructions - start here!<a href="multilevel-modelling-practical-6-week-7.html#instructions---start-here-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Exercise 1</strong> considers long and wide data shapes, illustrated by the Oxford boys data set. <strong>Exercise 2</strong> involves a simulation exercise (simulating from a two-level longitudinal model). You may also use this lab to work on the formative assignment.</p>
<p>Let’s begin by loading the necessary packages and data:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="multilevel-modelling-practical-6-week-7.html#cb182-1" tabindex="-1"></a><span class="fu">require</span>(lme4)</span>
<span id="cb182-2"><a href="multilevel-modelling-practical-6-week-7.html#cb182-2" tabindex="-1"></a><span class="fu">require</span>(lmerTest)</span>
<span id="cb182-3"><a href="multilevel-modelling-practical-6-week-7.html#cb182-3" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span></code></pre></div>
</div>
<div id="exercise-1-long-and-wide-data-shape" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Exercise 1 (Long and wide data shape)<a href="multilevel-modelling-practical-6-week-7.html#exercise-1-long-and-wide-data-shape" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s return to the Oxboys data, discussed in the lecture, which is a built-in R data set:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="multilevel-modelling-practical-6-week-7.html#cb183-1" tabindex="-1"></a><span class="fu">require</span>(nlme)</span>
<span id="cb183-2"><a href="multilevel-modelling-practical-6-week-7.html#cb183-2" tabindex="-1"></a><span class="fu">data</span>(Oxboys)</span></code></pre></div>
<p>This data set was by default given in <strong>long</strong> format. But assume we wanted this data in <strong>wide</strong> format, for instance in order to carry out a multivariate analysis.</p>
<p>Let’s have a brief look at the data frame:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="multilevel-modelling-practical-6-week-7.html#cb184-1" tabindex="-1"></a><span class="fu">head</span>(Oxboys)</span></code></pre></div>
<pre><code>## Grouped Data: height ~ age | Subject
##   Subject     age height Occasion
## 1       1 -1.0000  140.5        1
## 2       1 -0.7479  143.4        2
## 3       1 -0.4630  144.8        3
## 4       1 -0.1643  147.1        4
## 5       1 -0.0027  147.7        5
## 6       1  0.2466  150.2        6</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="multilevel-modelling-practical-6-week-7.html#cb186-1" tabindex="-1"></a><span class="fu">dim</span>(Oxboys)</span></code></pre></div>
<pre><code>## [1] 234   4</code></pre>
<p>We see that there are two variables capturing the “time” component:</p>
<ul>
<li>the <code>age</code> variable</li>
<li>the <code>Occasion</code> variable</li>
</ul>
<p>There is a one-to-one relationship between these two variables, so for the purpose of creating a “wide” data frame, we can choose any of these. In this case, we have decided to drop <code>age</code>:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="multilevel-modelling-practical-6-week-7.html#cb188-1" tabindex="-1"></a>Oxboys.wide <span class="ot">&lt;-</span> <span class="fu">reshape</span>(Oxboys, <span class="at">direction=</span><span class="st">&quot;wide&quot;</span>, <span class="at">idvar=</span><span class="st">&quot;Subject&quot;</span>, <span class="at">timevar=</span><span class="st">&quot;Occasion&quot;</span>, <span class="at">drop=</span><span class="st">&quot;age&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="multilevel-modelling-practical-6-week-7.html#cb189-1" tabindex="-1"></a><span class="fu">head</span>(Oxboys.wide)</span></code></pre></div>
<pre><code>##    Subject height.1 height.2 height.3 height.4 height.5 height.6 height.7 height.8 height.9
## 1        1    140.5    143.4    144.8   147.10   147.70    150.2    151.7    153.3    155.8
## 10       2    136.9    139.1    140.1   142.60   143.20    144.0    145.8    146.8    148.3
## 19       3    150.0    152.1    153.9   155.80   156.00    156.9    157.4    159.1    160.6
## 28       4    155.7    158.7    160.6   163.30   164.40    167.3    170.7    172.0    174.8
## 37       5    145.8    147.3    148.7   149.78   150.22    152.5    154.8    156.4    158.7
## 46       6    142.4    143.8    145.2   146.30   147.10    148.1    148.9    149.1    151.0</code></pre>
<p>We can produce pairwise scatterplots of the data, which gives a sense of the correlation between heights measured at different times:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="multilevel-modelling-practical-6-week-7.html#cb191-1" tabindex="-1"></a><span class="fu">plot</span>(Oxboys.wide[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">col=</span>Oxboys.wide<span class="sc">$</span>Subject)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-126-1.png" width="672" /></p>
<p>Let’s re-transform the data back into a long data format:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="multilevel-modelling-practical-6-week-7.html#cb192-1" tabindex="-1"></a>Oxboys.long<span class="ot">&lt;-</span> <span class="fu">reshape</span>(Oxboys.wide, <span class="at">direction=</span><span class="st">&quot;long&quot;</span>, </span>
<span id="cb192-2"><a href="multilevel-modelling-practical-6-week-7.html#cb192-2" tabindex="-1"></a>        <span class="at">idvar=</span><span class="st">&quot;Subject&quot;</span>, <span class="at">varying=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>),<span class="at">v.names=</span><span class="st">&quot;height&quot;</span> )</span>
<span id="cb192-3"><a href="multilevel-modelling-practical-6-week-7.html#cb192-3" tabindex="-1"></a><span class="fu">head</span>(Oxboys.long)</span></code></pre></div>
<pre><code>##     Subject time height
## 1.1       1    1  140.5
## 2.1       2    1  136.9
## 3.1       3    1  150.0
## 4.1       4    1  155.7
## 5.1       5    1  145.8
## 6.1       6    1  142.4</code></pre>
<p><strong>TASK:</strong> Convince yourself that the <code>Oxboys.long</code> data frame is equivalent to the original <code>Oxboys</code> frame. Check also the help file for <code>reshape</code> and make sure you’re happy with the syntax.</p>
<div id="regression-vs-multilevel-analysis" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> Regression vs multilevel analysis<a href="multilevel-modelling-practical-6-week-7.html#regression-vs-multilevel-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>By ignoring group structure, we can fit a regression model of the form</p>
<p><span class="math display">\[y_{ti}=a+b T_{ti}+\epsilon_{ti}\]</span></p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="multilevel-modelling-practical-6-week-7.html#cb194-1" tabindex="-1"></a>model.lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(height <span class="sc">~</span> age, <span class="at">data=</span>Oxboys)</span></code></pre></div>
<p>Let’s also obtain prediction intervals for each response value:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="multilevel-modelling-practical-6-week-7.html#cb195-1" tabindex="-1"></a>lmpred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">predict</span>(model.lm,<span class="at">interval=</span><span class="st">&quot;prediction&quot;</span>))</span>
<span id="cb195-2"><a href="multilevel-modelling-practical-6-week-7.html#cb195-2" tabindex="-1"></a>lmpred<span class="sc">$</span>age <span class="ot">&lt;-</span> Oxboys<span class="sc">$</span>age</span>
<span id="cb195-3"><a href="multilevel-modelling-practical-6-week-7.html#cb195-3" tabindex="-1"></a>lmpred<span class="sc">$</span>height <span class="ot">&lt;-</span> Oxboys<span class="sc">$</span>height</span>
<span id="cb195-4"><a href="multilevel-modelling-practical-6-week-7.html#cb195-4" tabindex="-1"></a>lmpred<span class="sc">$</span>Subject <span class="ot">&lt;-</span> Oxboys<span class="sc">$</span>Subject</span>
<span id="cb195-5"><a href="multilevel-modelling-practical-6-week-7.html#cb195-5" tabindex="-1"></a><span class="fu">head</span>(lmpred)</span></code></pre></div>
<pre><code>##        fit      lwr      upr     age height Subject
## 1 142.8508 126.8115 158.8901 -1.0000  140.5       1
## 2 144.4947 128.4920 160.4975 -0.7479  143.4       1
## 3 146.3526 130.3788 162.3263 -0.4630  144.8       1
## 4 148.3004 132.3430 164.2578 -0.1643  147.1       1
## 5 149.3542 133.3995 165.3088 -0.0027  147.7       1
## 6 150.9799 135.0212 166.9386  0.2466  150.2       1</code></pre>
<p>We see the fitted value <span class="math inline">\(\hat{y}_{ti} = \hat{a} +\hat{b} T_{ti}\)</span>, lower and upper limits of a 95% prediction interval, age, height and the subject label. Let’s plot the prediction interval for subject 2:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="multilevel-modelling-practical-6-week-7.html#cb197-1" tabindex="-1"></a>lmpredS2 <span class="ot">&lt;-</span> lmpred[lmpred<span class="sc">$</span>Subject<span class="sc">==</span><span class="dv">2</span>,]</span>
<span id="cb197-2"><a href="multilevel-modelling-practical-6-week-7.html#cb197-2" tabindex="-1"></a><span class="fu">ggplot</span>(lmpredS2,<span class="fu">aes</span>(age,height))<span class="sc">+</span></span>
<span id="cb197-3"><a href="multilevel-modelling-practical-6-week-7.html#cb197-3" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb197-4"><a href="multilevel-modelling-practical-6-week-7.html#cb197-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>fit))<span class="sc">+</span></span>
<span id="cb197-5"><a href="multilevel-modelling-practical-6-week-7.html#cb197-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>lwr))<span class="sc">+</span></span>
<span id="cb197-6"><a href="multilevel-modelling-practical-6-week-7.html#cb197-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>upr))</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-130-1.png" width="672" /></p>
<p>This doesn’t look terrible, although the fit tracks somewhat above the actual data.</p>
<p><strong>TASK:</strong> Try generating the above plots for different subjects (in particular, try subjects 1 and 10). Does the prediction interval change? If not, why not?</p>
<details>
<summary>
Click for solution
</summary>
<p>The prediction interval does not change. The model ignores group structure and can only explain one source of variation (within individuals) but not the variation between individuals. Consequently, the prediction intervals use the estimated error variance based on the entire data set, irrespective of which individual (subject) we’re looking at. We can see this by plotting the full data set and overlaying the prediction interval:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="multilevel-modelling-practical-6-week-7.html#cb198-1" tabindex="-1"></a><span class="fu">ggplot</span>(lmpred,<span class="fu">aes</span>(age,height))<span class="sc">+</span></span>
<span id="cb198-2"><a href="multilevel-modelling-practical-6-week-7.html#cb198-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>fit))<span class="sc">+</span></span>
<span id="cb198-3"><a href="multilevel-modelling-practical-6-week-7.html#cb198-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>lwr))<span class="sc">+</span></span>
<span id="cb198-4"><a href="multilevel-modelling-practical-6-week-7.html#cb198-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>upr))<span class="sc">+</span></span>
<span id="cb198-5"><a href="multilevel-modelling-practical-6-week-7.html#cb198-5" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col=</span>Subject),<span class="at">show.legend=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<img src="MLM_worksheets_files/figure-html/unnamed-chunk-131-1.png" width="672" />
</details>
<p><span class="math inline">\(~\)</span></p>
<p>Now, let’s fit a random intercept model of the form</p>
<p><span class="math display">\[y_{ti}=a+u_i + bT_{ti} + \epsilon_{ti}\]</span>
where the random intercept terms are <span class="math inline">\(u_i \sim N(0,\sigma^2_u)\)</span>. We use the following code to fit the model:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="multilevel-modelling-practical-6-week-7.html#cb199-1" tabindex="-1"></a>model.lmer <span class="ot">&lt;-</span> <span class="fu">lmer</span>(height <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>age<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>Subject),<span class="at">data=</span>Oxboys)</span></code></pre></div>
<p>To obtain prediction intervals based on the <code>lmer</code> output, we need the following package:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="multilevel-modelling-practical-6-week-7.html#cb200-1" tabindex="-1"></a><span class="fu">require</span>(merTools)</span></code></pre></div>
<p>Now obtain prediction intervals for each response value and append to the <code>lmpred</code> data frame to give a new data frame <code>pred</code>:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="multilevel-modelling-practical-6-week-7.html#cb201-1" tabindex="-1"></a>lmerpred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">predictInterval</span>(model.lmer))</span>
<span id="cb201-2"><a href="multilevel-modelling-practical-6-week-7.html#cb201-2" tabindex="-1"></a><span class="fu">names</span>(lmerpred) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;fit2&quot;</span>,<span class="st">&quot;lwr2&quot;</span>,<span class="st">&quot;upr2&quot;</span>)</span>
<span id="cb201-3"><a href="multilevel-modelling-practical-6-week-7.html#cb201-3" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">cbind</span>(lmerpred,lmpred)</span>
<span id="cb201-4"><a href="multilevel-modelling-practical-6-week-7.html#cb201-4" tabindex="-1"></a><span class="fu">head</span>(pred)</span></code></pre></div>
<pre><code>##       fit2     lwr2     upr2      fit      lwr      upr     age height Subject
## 1 141.6153 144.2665 138.8262 142.8508 126.8115 158.8901 -1.0000  140.5       1
## 2 143.2855 146.0189 140.5028 144.4947 128.4920 160.4975 -0.7479  143.4       1
## 3 145.0851 147.7315 142.5478 146.3526 130.3788 162.3263 -0.4630  144.8       1
## 4 146.9969 149.7938 144.4247 148.3004 132.3430 164.2578 -0.1643  147.1       1
## 5 148.1749 150.9344 145.4503 149.3542 133.3995 165.3088 -0.0027  147.7       1
## 6 149.7160 152.5418 147.0057 150.9799 135.0212 166.9386  0.2466  150.2       1</code></pre>
<p>Finally, we can overlay prediction intervals for subject 2:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="multilevel-modelling-practical-6-week-7.html#cb203-1" tabindex="-1"></a>predS2 <span class="ot">&lt;-</span> pred[pred<span class="sc">$</span>Subject<span class="sc">==</span><span class="dv">2</span>,]</span>
<span id="cb203-2"><a href="multilevel-modelling-practical-6-week-7.html#cb203-2" tabindex="-1"></a><span class="fu">ggplot</span>(predS2,<span class="fu">aes</span>(age,height))<span class="sc">+</span></span>
<span id="cb203-3"><a href="multilevel-modelling-practical-6-week-7.html#cb203-3" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb203-4"><a href="multilevel-modelling-practical-6-week-7.html#cb203-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>fit))<span class="sc">+</span></span>
<span id="cb203-5"><a href="multilevel-modelling-practical-6-week-7.html#cb203-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>lwr))<span class="sc">+</span></span>
<span id="cb203-6"><a href="multilevel-modelling-practical-6-week-7.html#cb203-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>upr))<span class="sc">+</span></span>
<span id="cb203-7"><a href="multilevel-modelling-practical-6-week-7.html#cb203-7" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>fit2),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb203-8"><a href="multilevel-modelling-practical-6-week-7.html#cb203-8" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>lwr2),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb203-9"><a href="multilevel-modelling-practical-6-week-7.html#cb203-9" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>upr2),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-135-1.png" width="672" /></p>
<p>The prediction interval based on the random intercept model is much tighter (since the within subjects variation is considerably lower than for the simple linear regression model which ignores group structure).</p>
<p>To see this, consider first the summary of the linear regression model:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="multilevel-modelling-practical-6-week-7.html#cb204-1" tabindex="-1"></a><span class="fu">summary</span>(model.lm)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = height ~ age, data = Oxboys)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -21.6570  -5.1403   0.4872   4.7514  18.9430 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 149.3718     0.5286 282.599  &lt; 2e-16 ***
## age           6.5210     0.8170   7.982 6.64e-14 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 8.081 on 232 degrees of freedom
## Multiple R-squared:  0.2154, Adjusted R-squared:  0.2121 
## F-statistic: 63.71 on 1 and 232 DF,  p-value: 6.635e-14</code></pre>
<p>The square of the residual standard error gives an estimate of the residual error variance <span class="math inline">\(\sigma^2\)</span>.</p>
<p>Now consider the summary of the random intercept model:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="multilevel-modelling-practical-6-week-7.html#cb206-1" tabindex="-1"></a><span class="fu">summary</span>(model.lmer)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [&#39;lmerModLmerTest&#39;]
## Formula: height ~ 1 + age + (1 | Subject)
##    Data: Oxboys
## 
## REML criterion at convergence: 940
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.1857 -0.6350 -0.1339  0.6252  2.5357 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Subject  (Intercept) 65.555   8.097   
##  Residual              1.718   1.311   
## Number of obs: 234, groups:  Subject, 26
## 
## Fixed effects:
##             Estimate Std. Error       df t value Pr(&gt;|t|)    
## (Intercept) 149.3717     1.5902  25.0002   93.93   &lt;2e-16 ***
## age           6.5239     0.1325 207.0000   49.23   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##     (Intr)
## age -0.002</code></pre>
<p>Look at the random effect variance estimate <span class="math inline">\(\sigma^2_u\)</span> versus the estimate of residual variance <span class="math inline">\(\sigma^2\)</span>. Most of the variation is between subjects! Hence, after accounting for group structure, the within subjects variation is relatively small.</p>
<p><span class="math inline">\(~\)</span></p>
</div>
</div>
<div id="exercise-2-simulation-from-the-two-level-longitudinal-model" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Exercise 2 (simulation from the two-level longitudinal model)<a href="multilevel-modelling-practical-6-week-7.html#exercise-2-simulation-from-the-two-level-longitudinal-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Suppose that we want to set up and simulate from a hypothetical model of MATH43515 student stress levels (for 30 students) over a 6 week period with the following variables:</p>
<ul>
<li><code>stress</code> - response variable on [0,100] with 100 representing max stress.</li>
<li><code>week</code> - time covariate taking values 1 to 6.</li>
<li><code>ML</code> - a binary (upper level) covariate taking the value 1 if a student has taken the Machine Learning module and 0 otherwise.</li>
<li><code>ID</code> - a unique student identifier.</li>
</ul>
<p>Imagine that the model we want to simulate from takes the form</p>
<p><span class="math display">\[y_{ti}=a + u_i + b T_{ti} + v_i T_{ti} + c z_i + \epsilon_{ti}, \quad i=1,\ldots,30, \quad t=1,\ldots,6\]</span>
where <span class="math inline">\(T_{ti}=t-1\)</span> represents week number, <span class="math inline">\(z_i\)</span> represents the binary <code>ML</code> variable, <span class="math inline">\(u_i \sim N(0,\sigma^2_u)\)</span>, <span class="math inline">\(v_i \sim N(0,\sigma^2_v)\)</span> and <span class="math inline">\(\epsilon_{ti}\sim N(0,\sigma^2)\)</span>.</p>
<p>Let’s set up a data frame within which to store the simulated data:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="multilevel-modelling-practical-6-week-7.html#cb208-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">43515</span>)</span>
<span id="cb208-2"><a href="multilevel-modelling-practical-6-week-7.html#cb208-2" tabindex="-1"></a>ID <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">30</span>),<span class="dv">6</span>)</span>
<span id="cb208-3"><a href="multilevel-modelling-practical-6-week-7.html#cb208-3" tabindex="-1"></a>ML <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="dv">30</span>,<span class="at">replace=</span><span class="cn">TRUE</span>),<span class="dv">6</span>)</span>
<span id="cb208-4"><a href="multilevel-modelling-practical-6-week-7.html#cb208-4" tabindex="-1"></a>week <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">5</span>),<span class="at">each=</span><span class="dv">30</span>)</span>
<span id="cb208-5"><a href="multilevel-modelling-practical-6-week-7.html#cb208-5" tabindex="-1"></a>stress <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">180</span>) <span class="co">#overwrite this later</span></span>
<span id="cb208-6"><a href="multilevel-modelling-practical-6-week-7.html#cb208-6" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ID,stress,week,ML) </span></code></pre></div>
<p>We will need to pick some parameter values. How about:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="multilevel-modelling-practical-6-week-7.html#cb209-1" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">40</span> <span class="co">#baseline stress level</span></span>
<span id="cb209-2"><a href="multilevel-modelling-practical-6-week-7.html#cb209-2" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co">#stress increases 5 units with every week</span></span>
<span id="cb209-3"><a href="multilevel-modelling-practical-6-week-7.html#cb209-3" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co">#if you&#39;re taking ML, expected stress increases by 5 units!</span></span>
<span id="cb209-4"><a href="multilevel-modelling-practical-6-week-7.html#cb209-4" tabindex="-1"></a>sigu <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Random intercept standard deviation</span></span>
<span id="cb209-5"><a href="multilevel-modelling-practical-6-week-7.html#cb209-5" tabindex="-1"></a>sigv <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Random slope standard deviation</span></span>
<span id="cb209-6"><a href="multilevel-modelling-practical-6-week-7.html#cb209-6" tabindex="-1"></a>sig <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#error standard deviation</span></span></code></pre></div>
<p>Now simulate from the model. We will do this by looping over time inside a loop over individuals:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="multilevel-modelling-practical-6-week-7.html#cb210-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">43515</span>) <span class="co">#for reproducibility</span></span>
<span id="cb210-2"><a href="multilevel-modelling-practical-6-week-7.html#cb210-2" tabindex="-1"></a><span class="co">#Simulate individual random effects</span></span>
<span id="cb210-3"><a href="multilevel-modelling-practical-6-week-7.html#cb210-3" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">30</span>,<span class="dv">0</span>,sigu)</span>
<span id="cb210-4"><a href="multilevel-modelling-practical-6-week-7.html#cb210-4" tabindex="-1"></a>vi <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">30</span>,<span class="dv">0</span>,sigv) </span>
<span id="cb210-5"><a href="multilevel-modelling-practical-6-week-7.html#cb210-5" tabindex="-1"></a><span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb210-6"><a href="multilevel-modelling-practical-6-week-7.html#cb210-6" tabindex="-1"></a>{ </span>
<span id="cb210-7"><a href="multilevel-modelling-practical-6-week-7.html#cb210-7" tabindex="-1"></a> <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb210-8"><a href="multilevel-modelling-practical-6-week-7.html#cb210-8" tabindex="-1"></a> {</span>
<span id="cb210-9"><a href="multilevel-modelling-practical-6-week-7.html#cb210-9" tabindex="-1"></a>  <span class="co">#simulate response at each time within individuals</span></span>
<span id="cb210-10"><a href="multilevel-modelling-practical-6-week-7.html#cb210-10" tabindex="-1"></a>  data<span class="sc">$</span>stress[(t<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">30</span><span class="sc">+</span>i] <span class="ot">&lt;-</span>  </span>
<span id="cb210-11"><a href="multilevel-modelling-practical-6-week-7.html#cb210-11" tabindex="-1"></a>    a<span class="sc">+</span>ui[i]<span class="sc">+</span>(b<span class="sc">+</span>vi[i])<span class="sc">*</span>(t<span class="dv">-1</span>)<span class="sc">+</span>c<span class="sc">*</span>data<span class="sc">$</span>ML[(t<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">30</span><span class="sc">+</span>i]<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,sig)</span>
<span id="cb210-12"><a href="multilevel-modelling-practical-6-week-7.html#cb210-12" tabindex="-1"></a>  }</span>
<span id="cb210-13"><a href="multilevel-modelling-practical-6-week-7.html#cb210-13" tabindex="-1"></a>}</span>
<span id="cb210-14"><a href="multilevel-modelling-practical-6-week-7.html#cb210-14" tabindex="-1"></a><span class="fu">head</span>(data)</span></code></pre></div>
<pre><code>##   ID   stress week ML
## 1  1 45.48698    0  1
## 2  2 38.15454    0  0
## 3  3 46.78894    0  1
## 4  4 40.86827    0  0
## 5  5 44.64929    0  1
## 6  6 45.55972    0  1</code></pre>
<p>Notice how the random effects only change from individual to individual. Let’s visualise the data we’ve generated:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="multilevel-modelling-practical-6-week-7.html#cb212-1" tabindex="-1"></a><span class="fu">ggplot</span>(data,<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>stress,<span class="at">group=</span>ID,<span class="at">col=</span>ID))<span class="sc">+</span></span>
<span id="cb212-2"><a href="multilevel-modelling-practical-6-week-7.html#cb212-2" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb212-3"><a href="multilevel-modelling-practical-6-week-7.html#cb212-3" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>ML)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-141-1.png" width="672" /></p>
<p>Fit the model from which the data were simulated and check that the parameter estimates are consistent with the ground truth:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="multilevel-modelling-practical-6-week-7.html#cb213-1" tabindex="-1"></a>model.synth <span class="ot">&lt;-</span> <span class="fu">lmer</span>(stress <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>week<span class="sc">+</span>ML<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>week<span class="sc">|</span>ID),<span class="at">data=</span>data)</span>
<span id="cb213-2"><a href="multilevel-modelling-practical-6-week-7.html#cb213-2" tabindex="-1"></a><span class="fu">summary</span>(model.synth)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [&#39;lmerModLmerTest&#39;]
## Formula: stress ~ 1 + week + ML + (1 + week | ID)
##    Data: data
## 
## REML criterion at convergence: 639.4
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.50911 -0.59396  0.02096  0.62229  2.45261 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  ID       (Intercept) 0.5436   0.7373       
##           week        0.5565   0.7460   0.50
##  Residual             1.0127   1.0063       
## Number of obs: 180, groups:  ID, 30
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  39.8509     0.2499 28.3719  159.44  &lt; 2e-16 ***
## week          5.1770     0.1431 29.0001   36.17  &lt; 2e-16 ***
## ML            5.0378     0.3769 28.0001   13.37 1.12e-13 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##      (Intr) week  
## week  0.122       
## ML   -0.653  0.000</code></pre>
<p>All looks well - the fixed effect estimates and random effect variances are consistent with the ground truth values that generated the data. There are various ways in which you could perform further analysis and check against what you expect to see e.g. </p>
<ul>
<li>Check to see that the interaction between <code>ML</code> and <code>week</code> is insignificant.</li>
</ul>
<details>
<summary>
Click for solution
</summary>
<p>Add in the cross level interaction as follows:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="multilevel-modelling-practical-6-week-7.html#cb215-1" tabindex="-1"></a>model.synth2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(stress <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>week<span class="sc">+</span>ML<span class="sc">+</span>week<span class="sc">:</span>ML<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>week<span class="sc">|</span>ID),<span class="at">data=</span>data)</span>
<span id="cb215-2"><a href="multilevel-modelling-practical-6-week-7.html#cb215-2" tabindex="-1"></a><span class="fu">summary</span>(model.synth2)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [&#39;lmerModLmerTest&#39;]
## Formula: stress ~ 1 + week + ML + week:ML + (1 + week | ID)
##    Data: data
## 
## REML criterion at convergence: 639.7
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.49292 -0.59874  0.02114  0.62647  2.45536 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  ID       (Intercept) 0.5443   0.7378       
##           week        0.5720   0.7563   0.50
##  Residual             1.0127   1.0063       
## Number of obs: 180, groups:  ID, 30
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  39.8363     0.2514 27.9998 158.433  &lt; 2e-16 ***
## week          5.1088     0.1925 28.0001  26.542  &lt; 2e-16 ***
## ML            5.0713     0.3820 27.9998  13.277 1.32e-13 ***
## week:ML       0.1573     0.2924 28.0001   0.538    0.595    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##         (Intr) week   ML    
## week     0.163              
## ML      -0.658 -0.107       
## week:ML -0.107 -0.658  0.163</code></pre>
The p-value is well above the 5% threshold indicating insufficient evidence to reject the null hypothesis that the fixed effect for the cross level intereaction is zero. We therefore conclude that this term is not needed.
</details>
<p><span class="math inline">\(~\)</span></p>
<ul>
<li>Check that the random time slope is needed (we know it is!)</li>
</ul>
<details>
<summary>
Click for solution
</summary>
<p>Perform a likelihood ratio test of the null hypothesis <span class="math inline">\(H_0: \sigma_v=0\)</span> as follows:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="multilevel-modelling-practical-6-week-7.html#cb217-1" tabindex="-1"></a><span class="fu">ranova</span>(model.synth)</span></code></pre></div>
<pre><code>## ANOVA-like table for random-effects: Single term deletions
## 
## Model:
## stress ~ week + ML + (1 + week | ID)
##                         npar  logLik    AIC    LRT Df Pr(&gt;Chisq)    
## &lt;none&gt;                     7 -319.69 653.38                         
## week in (1 + week | ID)    5 -387.72 785.43 136.06  2  &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
We see a very small p-value suggesting strong evidence against the null hypothesis. We conlude that the random slope on <code>week</code> is needed.
</details>
<p><span class="math inline">\(~\)</span></p>
<ul>
<li>Check the residual diagnostics.</li>
</ul>
<details>
<summary>
Click for solution
</summary>
<p>Check residuals versus fitted values and normality of residuals and random effects:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="multilevel-modelling-practical-6-week-7.html#cb219-1" tabindex="-1"></a><span class="fu">plot</span>(model.synth)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-145-1.png" width="672" /></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="multilevel-modelling-practical-6-week-7.html#cb220-1" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">resid</span>(model.synth))</span>
<span id="cb220-2"><a href="multilevel-modelling-practical-6-week-7.html#cb220-2" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">resid</span>(model.synth), </span>
<span id="cb220-3"><a href="multilevel-modelling-practical-6-week-7.html#cb220-3" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-145-2.png" width="672" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="multilevel-modelling-practical-6-week-7.html#cb221-1" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">ranef</span>(model.synth)<span class="sc">$</span>ID[,<span class="dv">1</span>])</span>
<span id="cb221-2"><a href="multilevel-modelling-practical-6-week-7.html#cb221-2" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">ranef</span>(model.synth)<span class="sc">$</span>ID[,<span class="dv">1</span>], </span>
<span id="cb221-3"><a href="multilevel-modelling-practical-6-week-7.html#cb221-3" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-145-3.png" width="672" /></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="multilevel-modelling-practical-6-week-7.html#cb222-1" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">ranef</span>(model.synth)<span class="sc">$</span>ID[,<span class="dv">2</span>])</span>
<span id="cb222-2"><a href="multilevel-modelling-practical-6-week-7.html#cb222-2" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">ranef</span>(model.synth)<span class="sc">$</span>ID[,<span class="dv">2</span>], </span>
<span id="cb222-3"><a href="multilevel-modelling-practical-6-week-7.html#cb222-3" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="MLM_worksheets_files/figure-html/unnamed-chunk-145-4.png" width="672" /></p>
Unsurprisingly (given how the data were generated), the model assumptions look reasonable.
</details>
<p><span class="math inline">\(~\)</span></p>
<p>You could also consider adding in an additional covariate at the lower level!</p>
<p>If you’ve got this far and have time to spare, feel free to work on the formative assignment.</p>
<p><span class="math inline">\(~\)</span></p>
</div>
<div id="end-of-lab" class="section level2 hasAnchor" number="7.4">
<h2><span class="header-section-number">7.4</span> End of lab!<a href="multilevel-modelling-practical-6-week-7.html#end-of-lab" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="multilevel-modelling-practical-5-week-6.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="multilevel-modelling-practical-7-week-8.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"sidebar": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
